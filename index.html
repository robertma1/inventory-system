<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†ï¼ˆç·šä¸ŠæŸ¥è©¢ + ç›¸æ©Ÿæƒæ¢ç¢¼ï¼‰</title>

  <!-- ZXingï¼šiPhone æ¢ç¢¼æƒæç©©å®šæ–¹æ¡ˆ -->
  <script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#223153;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, #1f3a8a55, transparent),
        radial-gradient(900px 600px at 110% 10%, #0ea5e955, transparent),
        var(--bg);
      color:var(--text);
      padding-bottom: env(safe-area-inset-bottom);
    }
    header{
      padding:18px 16px 10px;
      max-width: 1200px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.45}
    main{max-width:1200px; margin:0 auto; padding:10px 16px 28px; display:grid; gap:14px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd b{font-size:13px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, textarea, select{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
      font-size:16px; /* iPhone é¿å…è‡ªå‹•æ”¾å¤§ */
    }
    input:focus, textarea:focus, select:focus{border-color:#3b82f6aa; box-shadow:0 0 0 4px #3b82f622}
    .field{flex:1; min-width:140px}
    .field.sm{flex:.55; min-width:120px}
    .field.lg{flex:1.6; min-width:220px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
      font-size:13px;
      touch-action: manipulation;
    }
    button:hover{transform: translateY(-1px); border-color:#3b82f6aa}
    button.primary{background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#2563eb;}
    button.ghost{background:transparent}
    button.good{background: linear-gradient(180deg, #059669, #047857); border-color:#10b981}
    button.warn{background: linear-gradient(180deg, #d97706, #b45309); border-color:#f59e0b}
    button.bad{background: linear-gradient(180deg, #e11d48, #be123c); border-color:#fb7185}
    button.small{padding:8px 10px; font-size:12px}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted); font-weight:700; text-align:left; background: rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      min-width: 150px;
    }
    .kpi .box .n{font-size:18px; font-weight:800}
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      max-width: 720px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(17,26,46,.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:none;
      font-size:13px;
      line-height:1.5;
      z-index: 9999;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .toast.show{display:block}
    .toast.good{border-color:#10b98177}
    .toast.warn{border-color:#f59e0b77}
    .toast.bad{border-color:#fb718577}
    .help{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 740px){ .split{grid-template-columns:1fr} }
    .pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      color: #cbd5e1;
      max-height: 240px;
      overflow:auto;
    }

    /* Scanner modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9998;
    }
    .modal.show{ display:flex; }
    .modal .panel{
      width: min(920px, 100%);
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,.5);
    }
    .modal .panel .hd{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .modal .panel .bd{ padding: 12px 14px; }
    .videoWrap{
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
    }
    video{ width:100%; height:100%; object-fit: cover; }
    .scanHint{
      position:absolute; inset:auto 10px 10px 10px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      color: #e5e7eb;
    }
    .scanTools{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†</h1>
    <div class="sub">
      âœ… Catalog/Inventory æœ¬æ©Ÿä¿å­˜ï½œâœ… ç·šä¸ŠæŸ¥è©¢ SKU è‡ªå‹•è£œè³‡æ–™ï¼ˆå•†å“é è§£æï¼‰ï½œâœ… iPhone ç›¸æ©Ÿæƒæ¢ç¢¼ï¼ˆZXingï¼‰
    </div>
  </div>
  <div class="pill">âœ… GitHub Pages / localStorage</div>
</header>

<main>

  <div class="card">
    <div class="hd">
      <b>ç¸½è¦½</b>
      <div class="pill" id="savePill">æœ€è¿‘ä¿å­˜ï¼šâ€”</div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="box">
          <div class="n" id="kpiInventoryItems">0</div>
          <div class="t">åº«å­˜å“é …æ•¸ï¼ˆSKUï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiTotalQty">0</div>
          <div class="t">åº«å­˜ç¸½æ•¸é‡ï¼ˆQty åŠ ç¸½ï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiCatalogCount">0</div>
          <div class="t">Catalog è²¨è™Ÿç­†æ•¸</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- Left -->
    <section class="card">
      <div class="hd">
        <b>æ–°å¢ / æ›´æ–° / å”®å‡º</b>
        <span class="pill">SKU â†’ è‡ªå‹•è¾¨è­˜</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field sm">
            <label>SKUï¼ˆå¯æƒæ¢ç¢¼ï¼‰</label>
            <input id="skuInput" class="mono" placeholder="ä¾‹å¦‚ï¼šSA2043" autocomplete="off" />
          </div>
          <div class="field sm">
            <label>æ•¸é‡ï¼ˆQtyï¼‰</label>
            <input id="qtyInput" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š3" />
          </div>
          <div class="field lg">
            <label>è¾¨è­˜çµæœï¼ˆCatalog / ç·šä¸Šï¼‰</label>
            <input id="autoInfo" placeholder="è¼¸å…¥ SKU æˆ–æƒæå¾Œé¡¯ç¤ºâ€¦" readonly />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="addBtn">åŠ å…¥ / æ›´æ–°åº«å­˜</button>
          <button class="warn" id="sellBtn">å”®å‡ºï¼ˆæ‰£åº«å­˜ï¼‰</button>
          <button id="lookupBtn">ç·šä¸ŠæŸ¥è©¢ SKU</button>
          <button class="good" id="scanBtn">ğŸ“· æƒææ¢ç¢¼è¼¸å…¥ SKU</button>
          <button class="ghost" id="clearFormBtn">æ¸…ç©ºè¼¸å…¥</button>
        </div>

        <div class="help" id="browserHint"></div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

        <div class="split">
          <div>
            <b class="small">Catalogï¼ˆSKU â†’ å•†å“è³‡è¨Šï¼‰</b>
            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>å“ç‰Œ</label>
                <input id="brandInput" placeholder="JC Wings" />
              </div>
              <div class="field">
                <label>èˆªç©ºå…¬å¸</label>
                <input id="airlineInput" placeholder="Japan Airlines" />
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>æ©Ÿå‹</label>
                <input id="typeInput" placeholder="Boeing 777-200ER" />
              </div>
              <div class="field">
                <label>æ©Ÿèº«ç·¨è™Ÿï¼ˆRegï¼‰</label>
                <input id="regInput" class="mono" placeholder="JA702J" />
              </div>
              <div class="field sm">
                <label>æ¯”ä¾‹</label>
                <input id="scaleInput" class="mono" placeholder="1:200" />
              </div>
            </div>

            <div class="btns">
              <button class="good" id="saveCatalogBtn">å­˜å…¥ Catalog</button>
              <button class="warn" id="deleteCatalogBtn">å¾ Catalog åˆªé™¤æ­¤ SKU</button>
            </div>

            <div class="help">
              ç·šä¸ŠæŸ¥è©¢æˆåŠŸå¾Œï¼Œä»¥ä¸Šæ¬„ä½æœƒè‡ªå‹•å¡«å¥½ï¼›æŒ‰ã€Œå­˜å…¥ Catalogã€å³å¯å®Œæˆå»ºæª”ã€‚
            </div>
          </div>

          <div>
            <b class="small">å·¥å…·</b>
            <div class="btns" style="margin-top:10px">
              <button id="resetDemoBtn">é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™</button>
              <button class="bad" id="wipeAllBtn">æ¸…é™¤å…¨éƒ¨è³‡æ–™ï¼ˆCatalog+Inventoryï¼‰</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

            <b class="small">ç·šä¸Šè³‡æ–™ä¾†æº</b>
            <div class="help">
              å˜—è©¦ï¼šScalemodelstore / WingsWorld / AviationMegastore
              ï¼ˆå‰ç«¯æŠ“å–ä½¿ç”¨ jina.ai è½‰è®€ï¼Œé¿å… CORSï¼‰
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="hd">
        <b>åº«å­˜æ¸…å–®</b>
        <div class="row" style="gap:8px; align-items:center">
          <input id="searchInput" placeholder="æœå°‹ï¼šSKU / èˆªç©ºå…¬å¸ / æ©Ÿå‹ / Regâ€¦" style="width:280px; max-width:52vw;" />
          <button id="exportInventoryBtn">åŒ¯å‡º Inventory JSON</button>
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:90px">SKU</th>
                <th style="min-width:100px">å“ç‰Œ</th>
                <th style="min-width:140px">èˆªç©ºå…¬å¸</th>
                <th style="min-width:160px">æ©Ÿå‹</th>
                <th style="min-width:100px">Reg</th>
                <th style="min-width:80px">æ¯”ä¾‹</th>
                <th class="right" style="min-width:120px">æ•¸é‡</th>
                <th class="right" style="min-width:180px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="invBody">
              <tr><td colspan="8" class="muted">å°šç„¡åº«å­˜ã€‚è«‹åœ¨å·¦å´æ–°å¢ã€‚</td></tr>
            </tbody>
          </table>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="warn" id="importInventoryBtn">åŒ¯å…¥ Inventory JSON</button>
          <button id="exportCatalogBtn">åŒ¯å‡º Catalog JSON</button>
          <button class="warn" id="importCatalogBtn">åŒ¯å…¥ Catalog JSON</button>
        </div>
      </div>
    </section>

  </div>

  <!-- JSON -->
  <section class="card">
    <div class="hd">
      <b>åŒ¯å…¥ / åŒ¯å‡ºå…§å®¹</b>
      <span class="pill">JSONï¼ˆå¯å‚™ä»½/æ¬å®¶ï¼‰</span>
    </div>
    <div class="bd">
      <div class="split">
        <div>
          <label>è²¼ä¸Šè¦åŒ¯å…¥çš„ JSONï¼ˆCatalog æˆ– Inventoryï¼‰</label>
          <textarea id="jsonArea" rows="8" placeholder='è²¼ä¸Š JSON å¾Œå†æŒ‰ã€ŒåŒ¯å…¥ã€'></textarea>
          <div class="btns">
            <button class="warn" id="doImportCatalogBtn">æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
            <button class="warn" id="doImportInventoryBtn">æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
          </div>
        </div>
        <div>
          <label>åŒ¯å‡ºçµæœï¼ˆå¯è¤‡è£½ä¿å­˜ï¼‰</label>
          <div class="pre" id="exportBox">{}</div>
          <div class="btns">
            <button id="copyExportBtn">è¤‡è£½åŒ¯å‡ºå…§å®¹</button>
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Scanner Modal -->
<div id="scanModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="hd">
      <b>æƒææ¢ç¢¼ï¼ˆè‡ªå‹•è¼¸å…¥ SKUï¼‰</b>
      <div class="row" style="gap:8px; align-items:center">
        <select id="cameraSelect" style="min-width: 220px;"></select>
        <button id="closeScanBtn" class="bad">é—œé–‰</button>
      </div>
    </div>
    <div class="bd">
      <div class="videoWrap">
        <video id="scanVideo" playsinline muted></video>
        <div class="scanHint">æŠŠæ¢ç¢¼æ”¾ä¸­é–“ã€‚è®€åˆ°å¾Œæœƒè‡ªå‹•å¡«å…¥ SKU ä¸¦é—œé–‰ã€‚</div>
      </div>

      <div class="scanTools">
        <button id="retryScanBtn" class="warn">é‡æ–°å•Ÿå‹•æƒæ</button>
        <button id="toggleTorchBtn" class="ghost">å˜—è©¦é–‹/é—œé–ƒå…‰ç‡ˆ</button>
      </div>

      <div class="help" id="scanStatus">å°šæœªé–‹å§‹â€¦</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /** ==========================
   *  Storage keys
   *  ========================== */
  const LS_KEYS = {
    catalog: "rf_catalog_v5",
    inventory: "rf_inventory_v5",
    lastSave: "rf_last_save_v5"
  };

  // Demo
  const DEMO_CATALOG = {
    "SA2043": { brand:"JC Wings", airline:"Japan Airlines", aircraft:"Boeing 777-200ER", reg:"JA702J", scale:"1:200" }
  };

  /** ==========================
   *  Online lookup
   *  ========================== */
  const JINA_PREFIX_S = "https://r.jina.ai/https://";

  // ä¸‰å€‹ä¾†æºï¼šå…ˆæŠ“æœå°‹é ï¼Œå†æŠ“å•†å“é ï¼ˆåªè§£æå•†å“é ï¼Œé¿å…æ··åˆ°å…¶ä»–å•†å“ï¼‰
  const SOURCES = [
    {
      name: "ScaleModelStore",
      base: "www.scalemodelstore.com",
      searchUrls: (sku) => [
        `https://www.scalemodelstore.com/search?q=${encodeURIComponent(sku)}`,
        `https://www.scalemodelstore.com/search?query=${encodeURIComponent(sku)}`
      ],
      productUrlPatterns: [
        /https?:\/\/www\.scalemodelstore\.com\/products\/[^\s"'<>]+/ig
      ]
    },
    {
      name: "WingsWorld",
      base: "www.wingsworld.cn",
      searchUrls: (sku) => [
        `https://www.wingsworld.cn/search?keyword=${encodeURIComponent(sku)}`,
        `https://www.wingsworld.cn/search?search=${encodeURIComponent(sku)}`
      ],
      productUrlPatterns: [
        /https?:\/\/www\.wingsworld\.cn\/product\/[^\s"'<>]+/ig,
        /https?:\/\/www\.wingsworld\.cn\/goods\/[^\s"'<>]+/ig
      ]
    },
    {
      name: "AviationMegastore",
      base: "www.aviationmegastore.com",
      searchUrls: (sku) => [
        `https://www.aviationmegastore.com/en/search/?q=${encodeURIComponent(sku)}`,
        `https://www.aviationmegastore.com/en/search/?query=${encodeURIComponent(sku)}`
      ],
      productUrlPatterns: [
        /https?:\/\/www\.aviationmegastore\.com\/en\/[^\s"'<>]+/ig
      ]
    }
  ];

  /** ==========================
   *  DOM helpers
   *  ========================== */
  const el = (id) => document.getElementById(id);
  function safeBind(id, evt, fn){
    const node = el(id);
    if(!node){ console.warn("Missing element:", id); return; }
    node.addEventListener(evt, fn);
  }

  function toast(msg, type="good"){
    const t = el("toast");
    t.className = `toast show ${type}`;
    t.textContent = msg;
    setTimeout(()=>{ t.className = "toast"; }, 3600);
  }

  function nowStamp(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function normalizeSKU(s){ return (s || "").trim().toUpperCase(); }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){
      return fallback;
    }
  }
  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
    localStorage.setItem(LS_KEYS.lastSave, nowStamp());
    updateSavePill();
  }
  function updateSavePill(){
    const stamp = localStorage.getItem(LS_KEYS.lastSave) || "â€”";
    el("savePill").textContent = `æœ€è¿‘ä¿å­˜ï¼š${stamp}`;
  }

  function formatInfo(p){
    if(!p) return "";
    return `${p.brand || "â€”"}ï½œ${p.airline || "â€”"}ï½œ${p.aircraft || "â€”"}ï½œ${p.reg || "â€”"}ï½œ${p.scale || "â€”"}`;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /** ==========================
   *  Browser hint
   *  ========================== */
  function showBrowserHint(){
    const ua = navigator.userAgent || "";
    const isInApp = /Line|FBAV|FBAN|Instagram|GSA|MicroMessenger/i.test(ua);
    el("browserHint").textContent =
      "iPhone æé†’ï¼šå»ºè­°ç”¨ Safari/Chrome é–‹å•Ÿï¼ˆLINE/FB/IG å…§å»ºç€è¦½å™¨å¸¸é™åˆ¶ç›¸æ©Ÿï¼‰ã€‚\n" +
      `ç›®å‰åµæ¸¬ï¼š${isInApp ? "å¯èƒ½æ˜¯å…§å»ºç€è¦½å™¨ï¼ˆIn-Appï¼‰" : "ä¸€èˆ¬ç€è¦½å™¨"}`;
  }
  showBrowserHint();

  /** ==========================
   *  Data init
   *  ========================== */
  let catalog = loadJSON(LS_KEYS.catalog, null);
  let inventory = loadJSON(LS_KEYS.inventory, null);

  function ensureInit(){
    if(!catalog || typeof catalog !== "object"){
      catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
      saveJSON(LS_KEYS.catalog, catalog);
    }
    if(!inventory || typeof inventory !== "object"){
      inventory = {};
      saveJSON(LS_KEYS.inventory, inventory);
    }
  }
  ensureInit();

  function updateKPIs(){
    const invKeys = Object.keys(inventory || {});
    el("kpiInventoryItems").textContent = invKeys.length;

    let total = 0;
    invKeys.forEach(k => total += Number(inventory[k].qty || 0));
    el("kpiTotalQty").textContent = total;

    el("kpiCatalogCount").textContent = Object.keys(catalog || {}).length;
  }

  function fillManualFields(p){
    el("brandInput").value = p?.brand || "";
    el("airlineInput").value = p?.airline || "";
    el("typeInput").value = p?.aircraft || "";
    el("regInput").value = p?.reg || "";
    el("scaleInput").value = p?.scale || "";
  }

  function setAutoInfoFromSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){
      el("autoInfo").value = "";
      return;
    }
    const p = catalog[sku];
    if(p){
      el("autoInfo").value = "âœ… Catalogï¼š " + formatInfo(p);
      fillManualFields(p);
    }else{
      el("autoInfo").value = "âš ï¸ Catalog æ‰¾ä¸åˆ°ã€‚å¯æŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ SKUã€è‡ªå‹•æŠ“è³‡æ–™ã€‚";
    }
  }

  function clearForm(){
    el("skuInput").value = "";
    el("qtyInput").value = "";
    el("autoInfo").value = "";
    fillManualFields(null);
  }

  /** ==========================
   *  Inventory ops
   *  ========================== */
  function addOrUpdateInventory(){
    const sku = normalizeSKU(el("skuInput").value);
    const qty = Math.floor(Number(el("qtyInput").value));
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!Number.isFinite(qty) || qty < 0){ toast("Qty è«‹è¼¸å…¥ 0 ä»¥ä¸Šæ•´æ•¸ã€‚","warn"); return; }

    const p = catalog[sku];
    if(!p){
      toast("æ­¤ SKU å°šæœªå»ºç«‹ Catalogï¼Œè«‹å…ˆç·šä¸ŠæŸ¥è©¢æˆ–æ‰‹å‹•è£œé½Šä¸¦å­˜å…¥ Catalogã€‚","warn");
      return;
    }

    inventory[sku] = {
      sku,
      qty,
      brand: p.brand || "",
      airline: p.airline || "",
      aircraft: p.aircraft || "",
      reg: p.reg || "",
      scale: p.scale || "",
      updatedAt: nowStamp()
    };

    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`å·²æ›´æ–°åº«å­˜ï¼š${sku}ï¼ˆQty=${qty}ï¼‰`);
  }

  function sellInventory(){
    const sku = normalizeSKU(el("skuInput").value);
    const sold = Math.floor(Number(el("qtyInput").value));
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!Number.isFinite(sold) || sold <= 0){ toast("å”®å‡ºæ•¸é‡è«‹è¼¸å…¥ 1 ä»¥ä¸Šæ•´æ•¸ã€‚","warn"); return; }

    const it = inventory[sku];
    if(!it){
      toast("Inventory æ‰¾ä¸åˆ°æ­¤ SKUï¼ˆè«‹å…ˆåŠ å…¥åº«å­˜ï¼‰ã€‚","warn");
      return;
    }

    const before = Number(it.qty || 0);
    const after = Math.max(0, before - sold);
    it.qty = after;
    it.updatedAt = nowStamp();

    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();

    toast(`å·²å”®å‡ºï¼š${sku}ï¼ˆ-${sold}ï¼Œå‰©é¤˜ ${after}ï¼‰`, after === 0 ? "warn" : "good");
  }

  function deleteInventorySKU(sku){
    delete inventory[sku];
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`å·²åˆªé™¤åº«å­˜ï¼š${sku}`,"bad");
  }

  function adjustQty(sku, delta){
    const it = inventory[sku];
    if(!it) return;
    it.qty = Math.max(0, Number(it.qty || 0) + delta);
    it.updatedAt = nowStamp();
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
  }

  function renderInventory(){
    const q = (el("searchInput").value || "").trim().toLowerCase();
    const keys = Object.keys(inventory || {}).sort((a,b)=>a.localeCompare(b));
    const rows = [];

    for(const sku of keys){
      const it = inventory[sku];
      const hay = [sku,it.brand,it.airline,it.aircraft,it.reg,it.scale].join(" ").toLowerCase();
      if(q && !hay.includes(q)) continue;

      rows.push(`
        <tr>
          <td class="mono"><b>${sku}</b><div class="muted small">${it.updatedAt || ""}</div></td>
          <td>${escapeHtml(it.brand)}</td>
          <td>${escapeHtml(it.airline)}</td>
          <td>${escapeHtml(it.aircraft)}</td>
          <td class="mono">${escapeHtml(it.reg)}</td>
          <td class="mono">${escapeHtml(it.scale)}</td>
          <td class="right"><b>${Number(it.qty || 0)}</b></td>
          <td class="right">
            <button class="small" onclick="window.__dec('${sku}')">-1</button>
            <button class="small" onclick="window.__inc('${sku}')">+1</button>
            <button class="small warn" onclick="window.__sell1('${sku}')">å”®å‡º1</button>
            <button class="small bad" onclick="window.__del('${sku}')">åˆªé™¤</button>
          </td>
        </tr>
      `);
    }

    el("invBody").innerHTML = rows.length
      ? rows.join("")
      : `<tr><td colspan="8" class="muted">æ²’æœ‰ç¬¦åˆçš„çµæœã€‚</td></tr>`;
  }

  window.__inc = (sku)=>adjustQty(sku, +1);
  window.__dec = (sku)=>adjustQty(sku, -1);
  window.__sell1 = (sku)=>{ el("skuInput").value = sku; el("qtyInput").value = 1; setAutoInfoFromSKU(); sellInventory(); };
  window.__del = (sku)=>deleteInventorySKU(sku);

  /** ==========================
   *  Catalog ops
   *  ========================== */
  function saveCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }

    const brand = el("brandInput").value.trim();
    const airline = el("airlineInput").value.trim();
    const aircraft = el("typeInput").value.trim();
    const reg = el("regInput").value.trim();
    const scale = el("scaleInput").value.trim();

    if(!brand || !airline || !aircraft || !reg || !scale){
      toast("è«‹è£œé½Šå“ç‰Œ/èˆªç©ºå…¬å¸/æ©Ÿå‹/Reg/æ¯”ä¾‹ï¼Œå†å­˜å…¥ Catalogã€‚","warn");
      return;
    }

    catalog[sku] = { brand, airline, aircraft, reg, scale };
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast(`å·²å­˜å…¥ Catalogï¼š${sku}`,"good");
  }

  function deleteCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!catalog[sku]){ toast("æ­¤ SKU ä¸åœ¨ Catalogã€‚","warn"); return; }

    delete catalog[sku];
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast(`å·²å¾ Catalog åˆªé™¤ï¼š${sku}`,"bad");
  }

  function resetDemo(){
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("å·²é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™ã€‚","good");
  }

  function wipeAll(){
    localStorage.removeItem(LS_KEYS.catalog);
    localStorage.removeItem(LS_KEYS.inventory);
    localStorage.removeItem(LS_KEYS.lastSave);
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("å·²æ¸…é™¤å…¨éƒ¨è³‡æ–™ä¸¦å›åˆ°ç¯„ä¾‹ç‹€æ…‹ã€‚","bad");
  }

  /** ==========================
   *  Import/Export
   *  ========================== */
  function exportToBox(obj){
    el("exportBox").textContent = JSON.stringify(obj, null, 2);
  }
  function copyExport(){
    const txt = el("exportBox").textContent || "";
    navigator.clipboard.writeText(txt)
      .then(()=>toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚"))
      .catch(()=>toast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚","warn"));
  }
  function parseJsonArea(){
    const raw = el("jsonArea").value.trim();
    if(!raw){ toast("è«‹å…ˆè²¼ä¸Š JSONã€‚","warn"); return null; }
    try{
      const obj = JSON.parse(raw);
      if(typeof obj !== "object" || obj === null){ toast("JSON å…§å®¹ä¸æ˜¯ç‰©ä»¶ã€‚","warn"); return null; }
      return obj;
    }catch(e){
      toast("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€—è™Ÿèˆ‡æ‹¬è™Ÿã€‚","bad");
      return null;
    }
  }
  function importCatalogFromArea(){
    const obj = parseJsonArea(); if(!obj) return;
    for(const [sku, v] of Object.entries(obj)){
      if(!v || typeof v !== "object"){ toast(`Catalog æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad"); return; }
      for(const k of ["brand","airline","aircraft","reg","scale"]){
        if(!(k in v)){ toast(`Catalog ç¼ºæ¬„ä½ï¼š${sku}.${k}`,"bad"); return; }
      }
    }
    catalog = obj;
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast("å·²åŒ¯å…¥ Catalogï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
  }
  function importInventoryFromArea(){
    const obj = parseJsonArea(); if(!obj) return;
    for(const [sku, v] of Object.entries(obj)){
      if(!v || typeof v !== "object"){ toast(`Inventory æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad"); return; }
      if(!("qty" in v)){ toast(`Inventory ç¼º qtyï¼š${sku}`,"bad"); return; }
    }
    inventory = obj;
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast("å·²åŒ¯å…¥ Inventoryï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
  }

  /** ==========================
   *  Online lookup helpers
   *  ========================== */
  function toJinaUrl(url){
    if(url.startsWith("https://")) return JINA_PREFIX_S + url.replace("https://","");
    throw new Error("Only https supported");
  }

  async function fetchTextViaJina(url){
    const u = toJinaUrl(url);
    const resp = await fetch(u, { cache: "no-store" });
    if(!resp.ok) throw new Error(`Fetch failed ${resp.status}`);
    return await resp.text();
  }

  function uniq(arr){
    return Array.from(new Set(arr));
  }

  function extractUrls(text){
    const urls = [];
    const re = /https?:\/\/[^\s"'<>]+/ig;
    let m;
    while((m = re.exec(text)) !== null){
      urls.push(m[0].replace(/[\)\]\}\>,]+$/,""));
    }
    return urls;
  }

  function normalizeAircraft(s){
    if(!s) return "";
    return s.replace(/\s+/g," ").trim();
  }

  function toNiceAirline(a){
    if(!a) return "";
    const map = {
      "JAPAN AIRLINES":"Japan Airlines",
      "ALL NIPPON AIRWAYS":"All Nippon Airways",
      "CATHAY PACIFIC":"Cathay Pacific",
      "SINGAPORE AIRLINES":"Singapore Airlines",
      "CHINA AIRLINES":"China Airlines",
      "EVA AIR":"EVA Air",
      "KOREAN AIR":"Korean Air",
      "QATAR AIRWAYS":"Qatar Airways",
      "BRITISH AIRWAYS":"British Airways",
      "AIR FRANCE":"Air France",
      "LUFTHANSA":"Lufthansa",
      "EMIRATES":"Emirates",
      "ETIHAD":"Etihad"
    };
    const up = a.toUpperCase().trim();
    if(map[up]) return map[up];
    // Title Case
    return a.split(" ").filter(Boolean).map(w => w[0] + w.slice(1).toLowerCase()).join(" ");
  }

  // âœ… åªå¾å•†å“é è§£æï¼ˆé¿å…æœå°‹é æ··åˆ°åˆ¥çš„å•†å“ï¼‰
  function parseProductPageText(sku, text){
    const t = (text || "").replace(/\s+/g," ").trim();

    const scale = (t.match(/\b1\s*[:\/]\s*(200|400|500|300|144|72|150)\b/i) || [])[0] || "";
    const scaleN = scale ? scale.replace(/\s+/g,"").replace("/",":") : "";

    // Regï¼šå¸¸è¦‹æ ¼å¼ï¼ˆJA702J / B-XXXX / N123AA / HLxxxx / ç­‰ï¼‰
    const reg = (t.match(/\b([A-Z]{1,3}-[A-Z0-9]{2,6}|[A-Z]{1,3}[0-9]{3,4}[A-Z]?|JA[0-9]{3,4}[A-Z])\b/i) || [])[0] || "";

    // Brandï¼šå¸¸è¦‹æ¨¡å‹å“ç‰Œ
    const BRANDS = [
      "JC WINGS","JCWINGS","PHOENIX","GEMINI","HERPA","INFLIGHT","PANDA","SKY500","NG MODELS","AV400","AEROCLASSICS","SKYMARKS"
    ];
    let brand = "";
    for(const b of BRANDS){
      const re = new RegExp("\\b" + b.replace(/\s+/g,"\\s*") + "\\b", "i");
      if(re.test(t)){
        brand = /JC/i.test(b) ? "JC Wings" : b.replace(/\s+/g," ");
        break;
      }
    }

    // Aircraftï¼šè¼ƒä¿å®ˆçš„æ©Ÿå‹æŠ“æ³•
    const aircraft =
      (t.match(/\b(Boeing\s*)?(707|717|727|737(?:\s*MAX)?|747(?:-8)?|757|767|777(?:-\s*(?:200|300))?(?:ER)?|787(?:-\s*(?:8|9|10))?)\b/i) || [])[0]
      || (t.match(/\b(Airbus\s*)?(A220(?:-\s*(?:100|300))?|A300|A310|A318|A319|A320(?:neo)?|A321(?:neo)?|A330(?:-\s*(?:200|300))?|A340|A350(?:-\s*(?:900|1000))?|A380)\b/i) || [])[0]
      || "";

    const aircraftN = normalizeAircraft(aircraft);

    // Airlineï¼šå•†å“é å¸¸å‡ºç¾ "Japan Airlines" ç­‰å­—çœ¼ï¼›é¿å…æŠ“åˆ°å°è¦½æ–‡å­—
    const AIRLINES = [
      "Japan Airlines","All Nippon Airways","Cathay Pacific","Singapore Airlines","China Airlines","EVA Air",
      "Korean Air","Qatar Airways","British Airways","Air France","Lufthansa","Emirates","Etihad",
      "JAL","ANA"
    ];
    let airline = "";
    // ç”¨ SKU é™„è¿‘ 800 å­—å…ƒä½œç‚ºè§£æçª—å£ï¼ˆå•†å“é æ›´ä¹¾æ·¨ï¼‰
    const up = t.toUpperCase();
    const k = sku.toUpperCase();
    const idx = up.indexOf(k);
    const ctx = idx >= 0 ? t.slice(Math.max(0, idx-800), Math.min(t.length, idx+800)) : t.slice(0, 2000);

    for(const a of AIRLINES){
      const re = new RegExp("\\b" + a.replace(/\s+/g,"\\s+") + "\\b", "i");
      if(re.test(ctx)){
        airline = a.toUpperCase() === "JAL" ? "Japan Airlines" : a.toUpperCase() === "ANA" ? "All Nippon Airways" : a;
        airline = toNiceAirline(airline);
        break;
      }
    }

    // Scoreï¼šç›¡é‡è¦åŒ…å« aircraft/scale/regï¼Œå¦å‰‡ä¸æ¡ç”¨
    const product = {
      brand,
      airline,
      aircraft: aircraftN,
      reg,
      scale: scaleN
    };

    const score =
      (product.brand ? 1 : 0) +
      (product.airline ? 2 : 0) +
      (product.aircraft ? 3 : 0) +
      (product.reg ? 2 : 0) +
      (product.scale ? 2 : 0);

    return { product, score };
  }

  async function findProductPagesFromSearch(source, sku){
    const found = [];
    for(const sUrl of source.searchUrls(sku)){
      try{
        const searchText = await fetchTextViaJina(sUrl);

        // å¿…é ˆçœ‹åˆ° SKU æ‰æœ‰æ„ç¾©ï¼ˆé¿å…è·‘å‡ºç„¡é—œæœå°‹ï¼‰
        if(!searchText.toUpperCase().includes(sku.toUpperCase())) continue;

        const urls = extractUrls(searchText);
        const domainUrls = urls.filter(u => u.includes(source.base));

        // åªä¿ç•™ç¬¦åˆå•†å“é  pattern çš„é€£çµ
        let productUrls = [];
        for(const pat of source.productUrlPatterns){
          const m = searchText.match(pat);
          if(m) productUrls.push(...m);
        }
        productUrls.push(...domainUrls);

        productUrls = uniq(productUrls);

        // å„ªå…ˆï¼šç¶²å€æœ¬èº«åŒ…å« SKU
        productUrls.sort((a,b)=>{
          const as = a.toUpperCase().includes(sku.toUpperCase()) ? 1 : 0;
          const bs = b.toUpperCase().includes(sku.toUpperCase()) ? 1 : 0;
          return bs - as;
        });

        // åªå–å‰å¹¾å€‹
        for(const u of productUrls.slice(0, 6)){
          if(found.length >= 6) break;
          found.push(u);
        }

        if(found.length) break;
      }catch(e){}
    }
    return uniq(found);
  }

  async function onlineLookupSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥æˆ–æƒæ SKUã€‚","warn"); return; }

    if(catalog[sku]){
      toast("Catalog å·²æœ‰æ­¤ SKUã€‚","good");
      setAutoInfoFromSKU();
      return;
    }

    el("lookupBtn").disabled = true;
    el("autoInfo").value = "ğŸ” ç·šä¸ŠæŸ¥è©¢ä¸­â€¦ï¼ˆæœƒå…ˆæ‰¾å•†å“é å†è§£æï¼‰";
    toast("é–‹å§‹ç·šä¸ŠæŸ¥è©¢â€¦","warn");

    try{
      const candidates = [];

      for(const src of SOURCES){
        const pages = await findProductPagesFromSearch(src, sku);

        // è‹¥æ‰¾ä¸åˆ°å•†å“é ï¼Œå°±ç•¥éï¼ˆé¿å…æ•´é äº‚çŒœé€ æˆéŒ¯èª¤ï¼‰
        if(!pages.length) continue;

        for(const pUrl of pages.slice(0, 3)){
          try{
            const txt = await fetchTextViaJina(pUrl);
            const parsed = parseProductPageText(sku, txt);
            if(parsed.score >= 6){
              candidates.push({ source: src.name, url: pUrl, ...parsed });
            }
          }catch(e){}
        }
      }

      if(!candidates.length){
        el("autoInfo").value = "âŒ æ‰¾ä¸åˆ°å¯é çš„å•†å“é è§£æçµæœï¼ˆå¯èƒ½ç¶²ç«™ç‰ˆå‹è®Šæ›´æˆ–æœå°‹çµæœä¸å« SKUï¼‰ã€‚";
        toast("ç·šä¸ŠæŸ¥è©¢å¤±æ•—ï¼ˆæ‰¾ä¸åˆ°å¯é è§£æï¼‰ã€‚","bad");
        return;
      }

      // å–åˆ†æ•¸æœ€é«˜
      candidates.sort((a,b)=>b.score - a.score);
      const best = candidates[0].product;

      fillManualFields(best);
      el("autoInfo").value = `âœ… ç·šä¸ŠæŸ¥è©¢æˆåŠŸï¼š${formatInfo(best)}ï¼ˆè«‹æŒ‰ã€Œå­˜å…¥ Catalogã€ä¿å­˜ï¼‰`;
      toast("ç·šä¸ŠæŸ¥è©¢æˆåŠŸ âœ… è«‹æŒ‰ã€Œå­˜å…¥ Catalogã€","good");

    } finally {
      el("lookupBtn").disabled = false;
    }
  }

  /** ==========================
   *  Scanner (ZXing primary)
   *  ========================== */
  let scanStream = null;
  let scanRunning = false;
  let zxingReader = null;
  let lastVideoTrack = null;
  let torchOn = false;

  function showScanModal(show){
    const m = el("scanModal");
    m.classList.toggle("show", !!show);
    m.setAttribute("aria-hidden", show ? "false" : "true");
  }
  function setScanStatus(msg){ el("scanStatus").textContent = msg; }

  async function listCameras(){
    const sel = el("cameraSelect");
    sel.innerHTML = "";
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");

    if(!cams.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "æ‰¾ä¸åˆ°ç›¸æ©Ÿ";
      sel.appendChild(opt);
      return;
    }

    for(const c of cams){
      const opt = document.createElement("option");
      opt.value = c.deviceId;
      opt.textContent = c.label || `Camera ${sel.length+1}`;
      sel.appendChild(opt);
    }
  }

  function onDetected(code){
    const v = normalizeSKU(code);
    if(!v) return;
    el("skuInput").value = v;
    setAutoInfoFromSKU();
    toast(`å·²æƒæåˆ°ï¼š${v}`,"good");
    stopScan();
    showScanModal(false);
  }

  function stopScan(){
    scanRunning = false;

    // stop decoding
    if(zxingReader){
      try{ zxingReader.reset(); }catch(e){}
      zxingReader = null;
    }

    // stop stream
    try{
      if(scanStream){
        scanStream.getTracks().forEach(t => t.stop());
      }
    }catch(e){}

    scanStream = null;
    lastVideoTrack = null;
    torchOn = false;

    // clear video
    const video = el("scanVideo");
    try{ video.pause(); }catch(e){}
    video.srcObject = null;

    setScanStatus("å·²åœæ­¢ã€‚");
  }

  async function startScan(){
    if(scanRunning) return;

    if(!window.isSecureContext){
      toast("ç›¸æ©Ÿéœ€è¦ HTTPSï¼ˆå®‰å…¨ç’°å¢ƒï¼‰ã€‚GitHub Pages æ‰èƒ½ç”¨ã€‚","bad");
      return;
    }
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚è«‹ç”¨ Safari/Chromeã€‚","bad");
      return;
    }
    if(!window.ZXingBrowser){
      toast("æƒæå™¨å…ƒä»¶è¼‰å…¥å¤±æ•—ï¼ˆZXingï¼‰ã€‚è«‹ç¢ºèªç¶²è·¯å¯é€£ unpkgã€‚","bad");
      return;
    }

    showScanModal(true);
    setScanStatus("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™â€¦");

    try{
      // å…ˆæ‹¿æ¬Šé™ï¼ˆiOS æ‰æœƒé¡¯ç¤º device labelï¼‰
      const tmp = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio:false });
      tmp.getTracks().forEach(t => t.stop());

      await listCameras();

      // å–å¾—ä½¿ç”¨è€…é¸çš„ cameraIdï¼ˆæˆ–ç©ºï¼‰
      const camId = el("cameraSelect").value || null;

      // ZXing è®€å–
      zxingReader = new window.ZXingBrowser.BrowserMultiFormatReader();

      scanRunning = true;
      setScanStatus("æƒæä¸­â€¦ï¼ˆè«‹æŠŠæ¢ç¢¼æ”¾ä¸­é–“ï¼Œè®€åˆ°æœƒè‡ªå‹•å¡«å…¥ SKU ä¸¦é—œé–‰ï¼‰");

      // âœ… decodeFromConstraints åœ¨ iPhone å¾ˆç©©ï¼šæˆ‘å€‘ä¸æ‰‹å‹• play videoï¼Œè®“ ZXing ç®¡
      const constraints = camId
        ? { video: { deviceId: { exact: camId } }, audio:false }
        : { video: { facingMode: { ideal: "environment" } }, audio:false };

      await zxingReader.decodeFromConstraints(constraints, el("scanVideo"), (result, err, controls) => {
        // controls å¯ç”¨æ–¼ stopï¼Œä½†æˆ‘å€‘ç”¨ stopScan() çµ±ä¸€
        try{
          // æŠ“ track åš torch
          const stream = el("scanVideo").srcObject;
          if(stream && !scanStream) scanStream = stream;
          if(stream && stream.getVideoTracks && stream.getVideoTracks()[0]){
            lastVideoTrack = stream.getVideoTracks()[0];
          }
        }catch(e){}

        if(!scanRunning) return;

        if(result){
          const text = result.getText ? result.getText() : String(result);
          onDetected(text);
          return;
        }

        // è®€ä¸åˆ°æ™‚ä¸è¦ç‹‚åˆ·éŒ¯èª¤ï¼Œåƒ…åœ¨ç¬¬ä¸€æ¬¡æç¤º
        if(err && err.name && err.name !== "NotFoundException"){
          // NotFoundException è¡¨ç¤ºæœ¬å¹€æ²’æƒåˆ°ï¼ˆæ­£å¸¸ï¼‰ï¼Œå…¶å®ƒæ‰é¡¯ç¤º
          setScanStatus(`æƒæä¸­â€¦ï¼ˆå¶ç™¼éŒ¯èª¤ï¼š${err.name}ï¼‰`);
        }
      });

    } catch (e) {
      console.error(e);
      const name = e?.name || "UnknownError";
      const msg = e?.message || "";

      setScanStatus(`ç›¸æ©Ÿ/æƒæå•Ÿå‹•å¤±æ•—\néŒ¯èª¤: ${name}\nè¨Šæ¯: ${msg}`);
      toast("ç›¸æ©Ÿ/æƒæå•Ÿå‹•å¤±æ•—ï¼ˆè«‹çœ‹ä¸‹æ–¹éŒ¯èª¤ï¼‰ã€‚","bad");

      stopScan();
    }
  }

  async function toggleTorch(){
    if(!lastVideoTrack){
      toast("å°šæœªå–å¾—ç›¸æ©Ÿ Trackï¼ˆè«‹å…ˆå•Ÿå‹•æƒæï¼‰ã€‚","warn");
      return;
    }
    const caps = lastVideoTrack.getCapabilities ? lastVideoTrack.getCapabilities() : {};
    if(!caps.torch){
      toast("æ­¤ç›¸æ©Ÿä¸æ”¯æ´é–ƒå…‰ç‡ˆæ§åˆ¶ã€‚","warn");
      return;
    }
    try{
      torchOn = !torchOn;
      await lastVideoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      toast(torchOn ? "å·²å˜—è©¦é–‹å•Ÿé–ƒå…‰ç‡ˆ" : "å·²å˜—è©¦é—œé–‰é–ƒå…‰ç‡ˆ","good");
    }catch(e){
      toast("é–ƒå…‰ç‡ˆæ§åˆ¶å¤±æ•—ï¼ˆiPhone å¯èƒ½é™åˆ¶ï¼‰ã€‚","warn");
    }
  }

  /** ==========================
   *  Bind events
   *  ========================== */
  safeBind("skuInput","input", setAutoInfoFromSKU);
  safeBind("skuInput","keydown", (e)=>{ if(e.key==="Enter") addOrUpdateInventory(); });
  safeBind("qtyInput","keydown", (e)=>{ if(e.key==="Enter") addOrUpdateInventory(); });

  safeBind("addBtn","click", addOrUpdateInventory);
  safeBind("sellBtn","click", sellInventory);
  safeBind("lookupBtn","click", onlineLookupSKU);

  safeBind("scanBtn","click", startScan);
  safeBind("retryScanBtn","click", ()=>{ stopScan(); startScan(); });
  safeBind("toggleTorchBtn","click", toggleTorch);

  safeBind("closeScanBtn","click", ()=>{ stopScan(); showScanModal(false); });

  // é»èƒŒæ™¯ä¹Ÿå¯é—œé–‰
  el("scanModal").addEventListener("click", (e)=>{
    if(e.target === el("scanModal")){
      stopScan();
      showScanModal(false);
    }
  });

  safeBind("cameraSelect","change", ()=>{ stopScan(); startScan(); });

  safeBind("clearFormBtn","click", clearForm);

  safeBind("saveCatalogBtn","click", saveCatalogForSKU);
  safeBind("deleteCatalogBtn","click", deleteCatalogForSKU);

  safeBind("searchInput","input", renderInventory);

  safeBind("exportCatalogBtn","click", ()=>{ exportToBox(catalog); toast("å·²åŒ¯å‡º Catalogã€‚"); });
  safeBind("exportInventoryBtn","click", ()=>{ exportToBox(inventory); toast("å·²åŒ¯å‡º Inventoryã€‚"); });

  safeBind("importCatalogBtn","click", ()=>toast("æŠŠ Catalog JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ã€ã€‚","warn"));
  safeBind("importInventoryBtn","click", ()=>toast("æŠŠ Inventory JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ã€ã€‚","warn"));

  safeBind("doImportCatalogBtn","click", importCatalogFromArea);
  safeBind("doImportInventoryBtn","click", importInventoryFromArea);

  safeBind("copyExportBtn","click", copyExport);

  safeBind("resetDemoBtn","click", resetDemo);
  safeBind("wipeAllBtn","click", wipeAll);

  /** ==========================
   *  Init
   *  ========================== */
  updateSavePill();
  updateKPIs();
  setAutoInfoFromSKU();
  renderInventory();
  toast("è¼‰å…¥å®Œæˆ âœ…","good");
});
</script>
</body>
</html>
