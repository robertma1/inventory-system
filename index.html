<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>飛機模型庫存管理（手機可掃條碼）</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#223153;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, #1f3a8a55, transparent),
        radial-gradient(900px 600px at 110% 10%, #0ea5e955, transparent),
        var(--bg);
      color:var(--text);
      padding-bottom: env(safe-area-inset-bottom);
    }
    header{
      padding:18px 16px 10px;
      max-width: 1200px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.45}
    main{max-width:1200px; margin:0 auto; padding:10px 16px 28px; display:grid; gap:14px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd b{font-size:13px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, textarea, select{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
      font-size:16px; /* 手機避免縮放 */
    }
    input:focus, textarea:focus, select:focus{border-color:#3b82f6aa; box-shadow:0 0 0 4px #3b82f622}
    .field{flex:1; min-width:140px}
    .field.sm{flex:.55; min-width:120px}
    .field.lg{flex:1.6; min-width:220px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
      font-size:13px;
      touch-action: manipulation;
    }
    button:hover{transform: translateY(-1px); border-color:#3b82f6aa}
    button.primary{background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#2563eb;}
    button.ghost{background:transparent}
    button.good{background: linear-gradient(180deg, #059669, #047857); border-color:#10b981}
    button.warn{background: linear-gradient(180deg, #d97706, #b45309); border-color:#f59e0b}
    button.bad{background: linear-gradient(180deg, #e11d48, #be123c); border-color:#fb7185}
    button.small{padding:8px 10px; font-size:12px}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted); font-weight:700; text-align:left; background: rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      min-width: 150px;
    }
    .kpi .box .n{font-size:18px; font-weight:800}
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(17,26,46,.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:none;
      font-size:13px;
      line-height:1.5;
      z-index: 9999;
    }
    .toast.show{display:block}
    .toast.good{border-color:#10b98177}
    .toast.warn{border-color:#f59e0b77}
    .toast.bad{border-color:#fb718577}
    .pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      color: #cbd5e1;
      max-height: 240px;
      overflow:auto;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>飛機模型庫存管理（手機可掃條碼）</h1>
    <div class="sub">
      介面有出來但按鈕沒反應，通常是 JS 綁定失敗。本版已改為 DOMContentLoaded + 安全綁定。
    </div>
  </div>
  <div class="pill">✅ localStorage 自動保存</div>
</header>

<main>
  <div class="card">
    <div class="hd">
      <b>總覽</b>
      <div class="pill" id="savePill">最近保存：—</div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="box">
          <div class="n" id="kpiInventoryItems">0</div>
          <div class="t">庫存品項數（SKU）</div>
        </div>
        <div class="box">
          <div class="n" id="kpiTotalQty">0</div>
          <div class="t">庫存總數量（Qty 加總）</div>
        </div>
        <div class="box">
          <div class="n" id="kpiCatalogCount">0</div>
          <div class="t">Catalog 貨號筆數</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <div class="hd">
        <b>新增 / 更新庫存</b>
        <span class="pill">輸入 SKU → 自動帶出</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field sm">
            <label>SKU</label>
            <input id="skuInput" class="mono" placeholder="例如：SA2043" />
          </div>
          <div class="field sm">
            <label>Qty</label>
            <input id="qtyInput" type="number" min="0" step="1" placeholder="例如：3" />
          </div>
          <div class="field lg">
            <label>辨識結果</label>
            <input id="autoInfo" placeholder="輸入 SKU 後顯示…" readonly />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="addBtn">加入 / 更新庫存</button>
          <button class="ghost" id="clearFormBtn">清空輸入</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

        <b class="small">手動補齊並存入 Catalog（測試用）</b>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>品牌</label><input id="brandInput" placeholder="JC Wings" /></div>
          <div class="field"><label>航空公司</label><input id="airlineInput" placeholder="Japan Airlines" /></div>
        </div>
        <div class="row">
          <div class="field"><label>機型</label><input id="typeInput" placeholder="Boeing 777-200ER" /></div>
          <div class="field"><label>Reg</label><input id="regInput" class="mono" placeholder="JA702J" /></div>
          <div class="field sm"><label>比例</label><input id="scaleInput" class="mono" placeholder="1:200" /></div>
        </div>
        <div class="btns">
          <button class="good" id="saveCatalogBtn">存入 Catalog</button>
          <button class="warn" id="deleteCatalogBtn">從 Catalog 刪除此 SKU</button>
          <button id="resetDemoBtn">重置為範例資料</button>
          <button class="bad" id="wipeAllBtn">清除全部資料</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">
        <b>庫存清單</b>
        <div class="row" style="gap:8px; align-items:center">
          <input id="searchInput" placeholder="搜尋：SKU / 航空公司 / 機型 / Reg…" style="width:280px; max-width:52vw;" />
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>SKU</th><th>品牌</th><th>航空公司</th><th>機型</th><th>Reg</th><th>比例</th>
                <th class="right">Qty</th><th class="right">操作</th>
              </tr>
            </thead>
            <tbody id="invBody">
              <tr><td colspan="8" class="muted">尚無庫存。</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
/** ======= 這版的關鍵：等 DOM ready 才開始抓元素與綁事件 ======= */

document.addEventListener("DOMContentLoaded", () => {

  const LS_KEYS = {
    catalog: "rf_catalog_fix_v1",
    inventory: "rf_inventory_fix_v1",
    lastSave: "rf_last_save_fix_v1"
  };

  const DEMO_CATALOG = {
    "SA2043": { brand:"JC Wings", airline:"Japan Airlines", aircraft:"Boeing 777-200ER", reg:"JA702J", scale:"1:200" }
  };

  const el = (id) => document.getElementById(id);

  function safeBind(id, evt, fn){
    const node = el(id);
    if(!node){
      console.warn("Missing element id:", id);
      return;
    }
    node.addEventListener(evt, fn);
  }

  function nowStamp(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function toast(msg, type="good"){
    const t = el("toast");
    if(!t) return alert(msg);
    t.className = `toast show ${type}`;
    t.textContent = msg;
    setTimeout(()=>{ t.className = "toast"; }, 2600);
  }

  function normalizeSKU(s){ return (s||"").trim().toUpperCase(); }
  function formatInfo(p){ return `${p.brand}｜${p.airline}｜${p.aircraft}｜${p.reg}｜${p.scale}`; }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }

  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
    localStorage.setItem(LS_KEYS.lastSave, nowStamp());
    updateSavePill();
  }

  let catalog = loadJSON(LS_KEYS.catalog, null);
  let inventory = loadJSON(LS_KEYS.inventory, null);

  function ensureInit(){
    if(!catalog || typeof catalog !== "object"){
      catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
      saveJSON(LS_KEYS.catalog, catalog);
    }
    if(!inventory || typeof inventory !== "object"){
      inventory = {};
      saveJSON(LS_KEYS.inventory, inventory);
    }
  }
  ensureInit();

  function updateSavePill(){
    const stamp = localStorage.getItem(LS_KEYS.lastSave) || "—";
    const p = el("savePill");
    if(p) p.textContent = `最近保存：${stamp}`;
  }

  function updateKPIs(){
    const invKeys = Object.keys(inventory || {});
    el("kpiInventoryItems").textContent = invKeys.length;

    let total = 0;
    invKeys.forEach(k => total += Number(inventory[k].qty || 0));
    el("kpiTotalQty").textContent = total;

    el("kpiCatalogCount").textContent = Object.keys(catalog || {}).length;
  }

  function setAutoInfoFromSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ el("autoInfo").value = ""; return; }
    const p = catalog[sku];
    if(p){
      el("autoInfo").value = "✅ " + formatInfo(p);
      el("brandInput").value = p.brand || "";
      el("airlineInput").value = p.airline || "";
      el("typeInput").value = p.aircraft || "";
      el("regInput").value = p.reg || "";
      el("scaleInput").value = p.scale || "";
    }else{
      el("autoInfo").value = "⚠️ Catalog 找不到此 SKU（可手動補齊後存入）";
    }
  }

  function clearForm(){
    ["skuInput","qtyInput","autoInfo","brandInput","airlineInput","typeInput","regInput","scaleInput"]
      .forEach(id => { const n = el(id); if(n) n.value = ""; });
  }

  function addOrUpdateInventory(){
    const sku = normalizeSKU(el("skuInput").value);
    const qty = Math.floor(Number(el("qtyInput").value));
    if(!sku){ toast("請先輸入 SKU。","warn"); return; }
    if(!Number.isFinite(qty) || qty < 0){ toast("Qty 請輸入 0 以上整數。","warn"); return; }
    const p = catalog[sku];
    if(!p){ toast("此 SKU 尚未建立 Catalog。","warn"); return; }

    inventory[sku] = { sku, qty, ...p, updatedAt: nowStamp() };
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`已更新庫存：${sku}（Qty=${qty}）`);
  }

  function deleteInventorySKU(sku){
    delete inventory[sku];
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`已刪除庫存：${sku}`,"bad");
  }

  function adjustQty(sku, delta){
    const it = inventory[sku];
    if(!it) return;
    it.qty = Math.max(0, Number(it.qty||0) + delta);
    it.updatedAt = nowStamp();
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderInventory(){
    const q = (el("searchInput").value || "").trim().toLowerCase();
    const keys = Object.keys(inventory || {}).sort((a,b)=>a.localeCompare(b));
    const rows = [];

    for(const sku of keys){
      const it = inventory[sku];
      const hay = [sku,it.brand,it.airline,it.aircraft,it.reg,it.scale].join(" ").toLowerCase();
      if(q && !hay.includes(q)) continue;

      rows.push(`
        <tr>
          <td class="mono"><b>${sku}</b><div class="muted small">${it.updatedAt||""}</div></td>
          <td>${escapeHtml(it.brand)}</td>
          <td>${escapeHtml(it.airline)}</td>
          <td>${escapeHtml(it.aircraft)}</td>
          <td class="mono">${escapeHtml(it.reg)}</td>
          <td class="mono">${escapeHtml(it.scale)}</td>
          <td class="right"><b>${Number(it.qty||0)}</b></td>
          <td class="right">
            <button onclick="window.__dec('${sku}')">-</button>
            <button onclick="window.__inc('${sku}')">+</button>
            <button class="bad" onclick="window.__del('${sku}')">刪除</button>
          </td>
        </tr>
      `);
    }

    el("invBody").innerHTML = rows.length
      ? rows.join("")
      : `<tr><td colspan="8" class="muted">沒有符合的結果。</td></tr>`;
  }

  window.__inc = (sku)=>adjustQty(sku, +1);
  window.__dec = (sku)=>adjustQty(sku, -1);
  window.__del = (sku)=>deleteInventorySKU(sku);

  function saveCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("請先輸入 SKU。","warn"); return; }

    const brand = el("brandInput").value.trim();
    const airline = el("airlineInput").value.trim();
    const aircraft = el("typeInput").value.trim();
    const reg = el("regInput").value.trim();
    const scale = el("scaleInput").value.trim();

    if(!brand || !airline || !aircraft || !reg || !scale){
      toast("請補齊品牌/航空公司/機型/Reg/比例。","warn");
      return;
    }

    catalog[sku] = { brand, airline, aircraft, reg, scale };
    saveJSON(LS_KEYS.catalog, catalog);
    setAutoInfoFromSKU();
    updateKPIs();
    toast(`已存入 Catalog：${sku}`,"good");
  }

  function deleteCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("請先輸入 SKU。","warn"); return; }
    if(!catalog[sku]){ toast("此 SKU 不在 Catalog。","warn"); return; }
    delete catalog[sku];
    saveJSON(LS_KEYS.catalog, catalog);
    setAutoInfoFromSKU();
    updateKPIs();
    toast(`已從 Catalog 刪除：${sku}`,"bad");
  }

  function resetDemo(){
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("已重置為範例資料。","good");
  }

  function wipeAll(){
    localStorage.removeItem(LS_KEYS.catalog);
    localStorage.removeItem(LS_KEYS.inventory);
    localStorage.removeItem(LS_KEYS.lastSave);
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("已清除全部資料。","bad");
  }

  // === 綁事件（安全綁定） ===
  safeBind("skuInput","input", setAutoInfoFromSKU);
  safeBind("addBtn","click", addOrUpdateInventory);
  safeBind("clearFormBtn","click", clearForm);
  safeBind("saveCatalogBtn","click", saveCatalogForSKU);
  safeBind("deleteCatalogBtn","click", deleteCatalogForSKU);
  safeBind("resetDemoBtn","click", resetDemo);
  safeBind("wipeAllBtn","click", wipeAll);
  safeBind("searchInput","input", renderInventory);

  // init
  updateSavePill();
  updateKPIs();
  setAutoInfoFromSKU();
  renderInventory();

  toast("已載入完成 ✅（按鈕應可正常運作）");
});
</script>
</body>
</html>
