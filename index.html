<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†ï¼ˆç·šä¸ŠæŸ¥è©¢ + ç›¸æ©Ÿæƒæ¢ç¢¼ï¼‰</title>

  <!-- ZXingï¼šæ¢ç¢¼æƒæå‚™æ´ï¼ˆBarcodeDetector ä¸æ”¯æ´æ™‚ä½¿ç”¨ï¼‰ -->
  <script src="https://unpkg.com/@zxing/browser@0.1.4/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#223153;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, #1f3a8a55, transparent),
        radial-gradient(900px 600px at 110% 10%, #0ea5e955, transparent),
        var(--bg);
      color:var(--text);
      padding-bottom: env(safe-area-inset-bottom);
    }
    header{
      padding:18px 16px 10px;
      max-width: 1200px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.45}
    main{max-width:1200px; margin:0 auto; padding:10px 16px 28px; display:grid; gap:14px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd b{font-size:13px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, textarea, select{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
      font-size:16px; /* æ‰‹æ©Ÿé¿å…ç¸®æ”¾ */
    }
    input:focus, textarea:focus, select:focus{border-color:#3b82f6aa; box-shadow:0 0 0 4px #3b82f622}
    .field{flex:1; min-width:140px}
    .field.sm{flex:.55; min-width:120px}
    .field.lg{flex:1.6; min-width:220px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
      font-size:13px;
      touch-action: manipulation;
    }
    button:hover{transform: translateY(-1px); border-color:#3b82f6aa}
    button.primary{background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#2563eb;}
    button.ghost{background:transparent}
    button.good{background: linear-gradient(180deg, #059669, #047857); border-color:#10b981}
    button.warn{background: linear-gradient(180deg, #d97706, #b45309); border-color:#f59e0b}
    button.bad{background: linear-gradient(180deg, #e11d48, #be123c); border-color:#fb7185}
    button.small{padding:8px 10px; font-size:12px}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted); font-weight:700; text-align:left; background: rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      min-width: 150px;
    }
    .kpi .box .n{font-size:18px; font-weight:800}
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      max-width: 560px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(17,26,46,.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:none;
      font-size:13px;
      line-height:1.5;
      z-index: 9999;
    }
    .toast.show{display:block}
    .toast.good{border-color:#10b98177}
    .toast.warn{border-color:#f59e0b77}
    .toast.bad{border-color:#fb718577}
    .help{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 740px){ .split{grid-template-columns:1fr} }
    .pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      color: #cbd5e1;
      max-height: 240px;
      overflow:auto;
    }

    /* Scanner modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9998;
    }
    .modal.show{ display:flex; }
    .modal .panel{
      width: min(880px, 100%);
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,.5);
    }
    .modal .panel .hd{
      padding: 12px 14px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .modal .panel .bd{ padding: 12px 14px; }
    .videoWrap{
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow:hidden;
    }
    video{ width:100%; height:100%; object-fit: cover; }
    .scanHint{
      position:absolute; inset:auto 10px 10px 10px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      color: #e5e7eb;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†</h1>
    <div class="sub">
      âœ… Catalog/Inventory æœ¬æ©Ÿä¿å­˜ï½œâœ… ç·šä¸ŠæŸ¥è©¢ SKU è‡ªå‹•è£œè³‡æ–™ï½œâœ… æ‰‹æ©Ÿç›¸æ©Ÿæƒæ¢ç¢¼è‡ªå‹•è¼¸å…¥ SKU
    </div>
  </div>
  <div class="pill">âœ… GitHub Pages / localStorage</div>
</header>

<main>

  <div class="card">
    <div class="hd">
      <b>ç¸½è¦½</b>
      <div class="pill" id="savePill">æœ€è¿‘ä¿å­˜ï¼šâ€”</div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="box">
          <div class="n" id="kpiInventoryItems">0</div>
          <div class="t">åº«å­˜å“é …æ•¸ï¼ˆSKUï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiTotalQty">0</div>
          <div class="t">åº«å­˜ç¸½æ•¸é‡ï¼ˆQty åŠ ç¸½ï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiCatalogCount">0</div>
          <div class="t">Catalog è²¨è™Ÿç­†æ•¸</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- Left: Input -->
    <section class="card">
      <div class="hd">
        <b>æ–°å¢ / æ›´æ–° / å”®å‡º</b>
        <span class="pill">SKU â†’ è‡ªå‹•è¾¨è­˜</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field sm">
            <label>SKUï¼ˆå¯æƒæ¢ç¢¼ï¼‰</label>
            <input id="skuInput" class="mono" placeholder="ä¾‹å¦‚ï¼šSA2043" autocomplete="off" />
          </div>
          <div class="field sm">
            <label>æ•¸é‡ï¼ˆQtyï¼‰</label>
            <input id="qtyInput" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š3" />
          </div>
          <div class="field lg">
            <label>è¾¨è­˜çµæœï¼ˆCatalog / ç·šä¸Šï¼‰</label>
            <input id="autoInfo" placeholder="è¼¸å…¥ SKU æˆ–æƒæå¾Œé¡¯ç¤ºâ€¦" readonly />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="addBtn">åŠ å…¥ / æ›´æ–°åº«å­˜</button>
          <button class="warn" id="sellBtn">å”®å‡ºï¼ˆæ‰£åº«å­˜ï¼‰</button>
          <button id="lookupBtn">ç·šä¸ŠæŸ¥è©¢ SKU</button>
          <button class="good" id="scanBtn">ğŸ“· æƒææ¢ç¢¼è¼¸å…¥ SKU</button>
          <button class="ghost" id="clearFormBtn">æ¸…ç©ºè¼¸å…¥</button>
        </div>

        <div class="help">
          - è‹¥ Catalog æœ‰æ­¤ SKUï¼šå¯ç›´æ¥åŠ å…¥/æ›´æ–°åº«å­˜ã€æˆ–å”®å‡ºæ‰£åº«å­˜ã€‚<br/>
          - è‹¥ Catalog æ²’æœ‰ï¼šæŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ SKUã€è‡ªå‹•æŠ“å“ç‰Œ/èˆªç©ºå…¬å¸/æ©Ÿå‹/Reg/æ¯”ä¾‹ â†’ å†æŒ‰ã€Œå­˜å…¥ Catalogã€ã€‚<br/>
          - æ‰‹æ©Ÿæƒç¢¼ï¼šè«‹ç”¨ <b>Safari/Chrome æ­£å¸¸ç€è¦½å™¨</b> é–‹å•Ÿï¼ˆé¿å… LINE/FB å…§å»ºç€è¦½å™¨ï¼‰ï¼Œä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

        <div class="split">
          <div>
            <b class="small">Catalogï¼ˆSKU â†’ å•†å“è³‡è¨Šï¼‰</b>
            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>å“ç‰Œ</label>
                <input id="brandInput" placeholder="JC Wings" />
              </div>
              <div class="field">
                <label>èˆªç©ºå…¬å¸</label>
                <input id="airlineInput" placeholder="Japan Airlines" />
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>æ©Ÿå‹</label>
                <input id="typeInput" placeholder="Boeing 777-200ER" />
              </div>
              <div class="field">
                <label>æ©Ÿèº«ç·¨è™Ÿï¼ˆRegï¼‰</label>
                <input id="regInput" class="mono" placeholder="JA702J" />
              </div>
              <div class="field sm">
                <label>æ¯”ä¾‹</label>
                <input id="scaleInput" class="mono" placeholder="1:200" />
              </div>
            </div>

            <div class="btns">
              <button class="good" id="saveCatalogBtn">å­˜å…¥ Catalog</button>
              <button class="warn" id="deleteCatalogBtn">å¾ Catalog åˆªé™¤æ­¤ SKU</button>
            </div>

            <div class="help">
              æç¤ºï¼šç·šä¸ŠæŸ¥è©¢æˆåŠŸå¾Œï¼Œé€™äº›æ¬„ä½æœƒè‡ªå‹•å¡«å¥½ï¼›ä½ åªè¦æŒ‰ã€Œå­˜å…¥ Catalogã€å°±å®Œæˆå»ºæª”ã€‚
            </div>
          </div>

          <div>
            <b class="small">å·¥å…·</b>
            <div class="btns" style="margin-top:10px">
              <button id="resetDemoBtn">é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™</button>
              <button class="bad" id="wipeAllBtn">æ¸…é™¤å…¨éƒ¨è³‡æ–™ï¼ˆCatalog+Inventoryï¼‰</button>
            </div>
            <div class="help">âš ï¸ æ¸…é™¤å…¨éƒ¨æœƒåˆªé™¤ç€è¦½å™¨ä¿å­˜è³‡æ–™ï¼ˆç„¡æ³•å¾©åŸï¼‰ã€‚</div>

            <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

            <b class="small">ç·šä¸Šè³‡æ–™ä¾†æºï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰</b>
            <div class="help">
              ç›®å‰æœƒå˜—è©¦ï¼šScalemodelstore / WingsWorld / AviationMegastoreã€‚<br/>
              ç´”å‰ç«¯æŠ“å–ç”¨ jina.ai è½‰è®€ï¼ˆé¿å… CORSï¼‰ã€‚å¦‚ç¶²ç«™ç‰ˆå‹æ”¹äº†å¯èƒ½è¦å¾®èª¿è§£æè¦å‰‡ã€‚
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Right: Inventory list -->
    <section class="card">
      <div class="hd">
        <b>åº«å­˜æ¸…å–®</b>
        <div class="row" style="gap:8px; align-items:center">
          <input id="searchInput" placeholder="æœå°‹ï¼šSKU / èˆªç©ºå…¬å¸ / æ©Ÿå‹ / Regâ€¦" style="width:280px; max-width:52vw;" />
          <button id="exportInventoryBtn">åŒ¯å‡º Inventory JSON</button>
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:90px">SKU</th>
                <th style="min-width:100px">å“ç‰Œ</th>
                <th style="min-width:140px">èˆªç©ºå…¬å¸</th>
                <th style="min-width:160px">æ©Ÿå‹</th>
                <th style="min-width:100px">Reg</th>
                <th style="min-width:80px">æ¯”ä¾‹</th>
                <th class="right" style="min-width:120px">æ•¸é‡</th>
                <th class="right" style="min-width:180px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="invBody">
              <tr><td colspan="8" class="muted">å°šç„¡åº«å­˜ã€‚è«‹åœ¨å·¦å´æ–°å¢ã€‚</td></tr>
            </tbody>
          </table>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="warn" id="importInventoryBtn">åŒ¯å…¥ Inventory JSON</button>
          <button id="exportCatalogBtn">åŒ¯å‡º Catalog JSON</button>
          <button class="warn" id="importCatalogBtn">åŒ¯å…¥ Catalog JSON</button>
        </div>

        <div class="help">
          å¿«é€Ÿæ“ä½œï¼š<br/>
          - ã€Œ-1ã€ã€Œ+1ã€å¿«é€Ÿèª¿æ•´åº«å­˜<br/>
          - ã€Œå”®å‡ºã€ç”¨å·¦é‚Šè¼¸å…¥ SKU + Qty ç›´æ¥æ‰£åº«å­˜
        </div>
      </div>
    </section>

  </div>

  <!-- Raw JSON preview / export -->
  <section class="card">
    <div class="hd">
      <b>åŒ¯å…¥ / åŒ¯å‡ºå…§å®¹</b>
      <span class="pill">JSONï¼ˆå¯å‚™ä»½/æ¬å®¶ï¼‰</span>
    </div>
    <div class="bd">
      <div class="split">
        <div>
          <label>è²¼ä¸Šè¦åŒ¯å…¥çš„ JSONï¼ˆCatalog æˆ– Inventoryï¼‰</label>
          <textarea id="jsonArea" rows="8" placeholder='è²¼ä¸Š JSON å¾Œå†æŒ‰ã€ŒåŒ¯å…¥ã€'></textarea>
          <div class="btns">
            <button class="warn" id="doImportCatalogBtn">æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
            <button class="warn" id="doImportInventoryBtn">æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
          </div>
          <div class="help">æ³¨æ„ï¼šåŒ¯å…¥æœƒè¦†è“‹ç›®å‰è³‡æ–™ï¼Œå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
        </div>
        <div>
          <label>åŒ¯å‡ºçµæœï¼ˆå¯è¤‡è£½ä¿å­˜ï¼‰</label>
          <div class="pre" id="exportBox">{}</div>
          <div class="btns">
            <button id="copyExportBtn">è¤‡è£½åŒ¯å‡ºå…§å®¹</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd"><b>GitHub Pages ä½¿ç”¨æé†’</b></div>
    <div class="bd help">
      1) ç›¸æ©Ÿæƒç¢¼éœ€è¦ HTTPSï¼ˆGitHub Pages âœ…ï¼‰<br/>
      2) iPhone å»ºè­°ç”¨ Safari/Chrome æ­£å¸¸ç€è¦½å™¨é–‹å•Ÿï¼Œä¸è¦ç”¨ LINE/FB å…§å»ºç€è¦½å™¨ï¼ˆå¸¸æœƒæ“‹ç›¸æ©Ÿæ¬Šé™ï¼‰<br/>
      3) è‹¥æŒ‰éˆ•ç„¡åæ‡‰ï¼šé€šå¸¸æ˜¯ JS å ±éŒ¯ï¼Œè«‹ç”¨é›»è…¦ Chrome â†’ å³éµã€Œæª¢æŸ¥ã€â†’ Console çœ‹ç´…å­—ï¼ˆè²¼çµ¦æˆ‘æˆ‘èƒ½ç«‹å³å®šä½ï¼‰
    </div>
  </section>

</main>

<!-- Scanner Modal -->
<div id="scanModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="hd">
      <b>æƒææ¢ç¢¼ï¼ˆè‡ªå‹•è¼¸å…¥ SKUï¼‰</b>
      <div class="row" style="gap:8px; align-items:center">
        <select id="cameraSelect" style="min-width: 220px;"></select>
        <button id="closeScanBtn" class="bad">é—œé–‰</button>
      </div>
    </div>
    <div class="bd">
      <div class="videoWrap">
        <video id="scanVideo" playsinline></video>
        <div class="scanHint">æŠŠæ¢ç¢¼æ”¾åœ¨ç•«é¢ä¸­é–“ï¼Œè®€åˆ°å¾Œæœƒè‡ªå‹•å¡«å…¥ SKU ä¸¦é—œé–‰è¦–çª—ã€‚</div>
      </div>
      <div class="help" id="scanStatus">å°šæœªé–‹å§‹â€¦</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /** ==========================
   *  localStorage keys & demo
   *  ========================== */
  const LS_KEYS = {
    catalog: "rf_catalog_v2",
    inventory: "rf_inventory_v2",
    lastSave: "rf_last_save_v2"
  };

  // å…§å»ºä¸€ç­†ç¯„ä¾‹ï¼ˆä½ æéçš„ï¼‰
  const DEMO_CATALOG = {
    "SA2043": { brand:"JC Wings", airline:"Japan Airlines", aircraft:"Boeing 777-200ER", reg:"JA702J", scale:"1:200" }
  };

  /** ==========================
   *  Online lookup settings
   *  ========================== */
  // ç”¨ jina.ai è½‰è®€ï¼šé¿å… GitHub Pages çš„ CORS é™åˆ¶
  // æœƒæŠ“åˆ°ç›®æ¨™é çš„ HTML æ–‡å­—ï¼ˆä¸åŒç¶²ç«™å¯èƒ½æ ¼å¼ä¸åŒï¼Œè§£æèµ° heuristicï¼‰
  const JINA_PREFIX = "https://r.jina.ai/http://";
  const JINA_PREFIX_S = "https://r.jina.ai/https://";

  // å˜—è©¦çš„ã€Œæœå°‹ URLã€æ¨¡æ¿ï¼ˆè‹¥ç¶²ç«™æ”¹ç‰ˆå¯åœ¨é€™è£¡èª¿æ•´ï¼‰
  // æ³¨æ„ï¼šä¸åŒç¶²ç«™å¯èƒ½éœ€è¦ä¸åŒ query paramï¼›ä»¥ä¸‹æ˜¯å¸¸è¦‹çŒœæ³•ã€‚
  const LOOKUP_SOURCES = [
    {
      name: "ScaleModelStore",
      homepage: "https://www.scalemodelstore.com/",
      searchUrls: (sku) => [
        `https://www.scalemodelstore.com/search?q=${encodeURIComponent(sku)}`,
        `https://www.scalemodelstore.com/search?query=${encodeURIComponent(sku)}`,
        `https://www.scalemodelstore.com/?s=${encodeURIComponent(sku)}`
      ]
    },
    {
      name: "WingsWorld",
      homepage: "https://www.wingsworld.cn/",
      searchUrls: (sku) => [
        `https://www.wingsworld.cn/search?keyword=${encodeURIComponent(sku)}`,
        `https://www.wingsworld.cn/search?search=${encodeURIComponent(sku)}`,
        `https://www.wingsworld.cn/?s=${encodeURIComponent(sku)}`
      ]
    },
    {
      name: "AviationMegastore",
      homepage: "https://www.aviationmegastore.com/en/",
      searchUrls: (sku) => [
        `https://www.aviationmegastore.com/en/search/?q=${encodeURIComponent(sku)}`,
        `https://www.aviationmegastore.com/en/search/?query=${encodeURIComponent(sku)}`
      ]
    }
  ];

  /** ==========================
   *  DOM helpers
   *  ========================== */
  const el = (id) => document.getElementById(id);
  function safeBind(id, evt, fn){
    const node = el(id);
    if(!node){ console.warn("Missing element:", id); return; }
    node.addEventListener(evt, fn);
  }

  function toast(msg, type="good"){
    const t = el("toast");
    if(!t) return alert(msg);
    t.className = `toast show ${type}`;
    t.textContent = msg;
    setTimeout(()=>{ t.className = "toast"; }, 2600);
  }

  function nowStamp(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function normalizeSKU(s){ return (s || "").trim().toUpperCase(); }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){
      return fallback;
    }
  }

  function saveJSON(key, obj){
    localStorage.setItem(key, JSON.stringify(obj));
    localStorage.setItem(LS_KEYS.lastSave, nowStamp());
    updateSavePill();
  }

  function updateSavePill(){
    const stamp = localStorage.getItem(LS_KEYS.lastSave) || "â€”";
    const p = el("savePill");
    if(p) p.textContent = `æœ€è¿‘ä¿å­˜ï¼š${stamp}`;
  }

  function formatInfo(p){
    if(!p) return "";
    return `${p.brand || "â€”"}ï½œ${p.airline || "â€”"}ï½œ${p.aircraft || "â€”"}ï½œ${p.reg || "â€”"}ï½œ${p.scale || "â€”"}`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  /** ==========================
   *  State
   *  ========================== */
  let catalog = loadJSON(LS_KEYS.catalog, null);
  let inventory = loadJSON(LS_KEYS.inventory, null);

  function ensureInit(){
    if(!catalog || typeof catalog !== "object"){
      catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
      saveJSON(LS_KEYS.catalog, catalog);
    }
    if(!inventory || typeof inventory !== "object"){
      inventory = {};
      saveJSON(LS_KEYS.inventory, inventory);
    }
  }
  ensureInit();

  /** ==========================
   *  UI update
   *  ========================== */
  function updateKPIs(){
    const invKeys = Object.keys(inventory || {});
    el("kpiInventoryItems").textContent = invKeys.length;

    let total = 0;
    invKeys.forEach(k => total += Number(inventory[k].qty || 0));
    el("kpiTotalQty").textContent = total;

    el("kpiCatalogCount").textContent = Object.keys(catalog || {}).length;
  }

  function fillManualFields(p){
    el("brandInput").value = p?.brand || "";
    el("airlineInput").value = p?.airline || "";
    el("typeInput").value = p?.aircraft || "";
    el("regInput").value = p?.reg || "";
    el("scaleInput").value = p?.scale || "";
  }

  function setAutoInfoFromSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){
      el("autoInfo").value = "";
      return;
    }
    const p = catalog[sku];
    if(p){
      el("autoInfo").value = "âœ… Catalogï¼š " + formatInfo(p);
      fillManualFields(p);
    }else{
      el("autoInfo").value = "âš ï¸ Catalog æ‰¾ä¸åˆ°ã€‚å¯æŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ SKUã€è‡ªå‹•æŠ“è³‡æ–™ã€‚";
    }
  }

  function clearForm(){
    el("skuInput").value = "";
    el("qtyInput").value = "";
    el("autoInfo").value = "";
    fillManualFields(null);
  }

  /** ==========================
   *  Inventory ops
   *  ========================== */
  function addOrUpdateInventory(){
    const sku = normalizeSKU(el("skuInput").value);
    const qty = Math.floor(Number(el("qtyInput").value));
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!Number.isFinite(qty) || qty < 0){ toast("Qty è«‹è¼¸å…¥ 0 ä»¥ä¸Šæ•´æ•¸ã€‚","warn"); return; }

    const p = catalog[sku];
    if(!p){
      toast("æ­¤ SKU å°šæœªå»ºç«‹ Catalogï¼Œè«‹å…ˆç·šä¸ŠæŸ¥è©¢æˆ–æ‰‹å‹•è£œé½Šä¸¦å­˜å…¥ Catalogã€‚","warn");
      return;
    }

    inventory[sku] = {
      sku,
      qty,
      brand: p.brand || "",
      airline: p.airline || "",
      aircraft: p.aircraft || "",
      reg: p.reg || "",
      scale: p.scale || "",
      updatedAt: nowStamp()
    };

    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`å·²æ›´æ–°åº«å­˜ï¼š${sku}ï¼ˆQty=${qty}ï¼‰`);
  }

  function sellInventory(){
    const sku = normalizeSKU(el("skuInput").value);
    const sold = Math.floor(Number(el("qtyInput").value));
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!Number.isFinite(sold) || sold <= 0){ toast("å”®å‡ºæ•¸é‡è«‹è¼¸å…¥ 1 ä»¥ä¸Šæ•´æ•¸ã€‚","warn"); return; }

    const it = inventory[sku];
    if(!it){
      toast("Inventory æ‰¾ä¸åˆ°æ­¤ SKUï¼ˆè«‹å…ˆåŠ å…¥åº«å­˜ï¼‰ã€‚","warn");
      return;
    }

    const before = Number(it.qty || 0);
    const after = Math.max(0, before - sold);
    it.qty = after;
    it.updatedAt = nowStamp();
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();

    toast(`å·²å”®å‡ºï¼š${sku}ï¼ˆ-${sold}ï¼Œå‰©é¤˜ ${after}ï¼‰`, after === 0 ? "warn" : "good");
  }

  function deleteInventorySKU(sku){
    delete inventory[sku];
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast(`å·²åˆªé™¤åº«å­˜ï¼š${sku}`,"bad");
  }

  function adjustQty(sku, delta){
    const it = inventory[sku];
    if(!it) return;
    it.qty = Math.max(0, Number(it.qty || 0) + delta);
    it.updatedAt = nowStamp();
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
  }

  function renderInventory(){
    const q = (el("searchInput").value || "").trim().toLowerCase();
    const keys = Object.keys(inventory || {}).sort((a,b)=>a.localeCompare(b));
    const rows = [];

    for(const sku of keys){
      const it = inventory[sku];
      const hay = [sku,it.brand,it.airline,it.aircraft,it.reg,it.scale].join(" ").toLowerCase();
      if(q && !hay.includes(q)) continue;

      rows.push(`
        <tr>
          <td class="mono"><b>${sku}</b><div class="muted small">${it.updatedAt || ""}</div></td>
          <td>${escapeHtml(it.brand)}</td>
          <td>${escapeHtml(it.airline)}</td>
          <td>${escapeHtml(it.aircraft)}</td>
          <td class="mono">${escapeHtml(it.reg)}</td>
          <td class="mono">${escapeHtml(it.scale)}</td>
          <td class="right"><b>${Number(it.qty || 0)}</b></td>
          <td class="right">
            <button class="small" onclick="window.__dec('${sku}')" title="-1">-1</button>
            <button class="small" onclick="window.__inc('${sku}')" title="+1">+1</button>
            <button class="small warn" onclick="window.__sell1('${sku}')" title="å”®å‡º 1">å”®å‡º1</button>
            <button class="small bad" onclick="window.__del('${sku}')" title="åˆªé™¤">åˆªé™¤</button>
          </td>
        </tr>
      `);
    }

    el("invBody").innerHTML = rows.length
      ? rows.join("")
      : `<tr><td colspan="8" class="muted">æ²’æœ‰ç¬¦åˆçš„çµæœã€‚</td></tr>`;
  }

  window.__inc = (sku)=>adjustQty(sku, +1);
  window.__dec = (sku)=>adjustQty(sku, -1);
  window.__sell1 = (sku)=>{ el("skuInput").value = sku; el("qtyInput").value = 1; setAutoInfoFromSKU(); sellInventory(); };
  window.__del = (sku)=>deleteInventorySKU(sku);

  /** ==========================
   *  Catalog ops
   *  ========================== */
  function saveCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }

    const brand = el("brandInput").value.trim();
    const airline = el("airlineInput").value.trim();
    const aircraft = el("typeInput").value.trim();
    const reg = el("regInput").value.trim();
    const scale = el("scaleInput").value.trim();

    if(!brand || !airline || !aircraft || !reg || !scale){
      toast("è«‹è£œé½Šå“ç‰Œ/èˆªç©ºå…¬å¸/æ©Ÿå‹/Reg/æ¯”ä¾‹ï¼Œå†å­˜å…¥ Catalogã€‚","warn");
      return;
    }

    catalog[sku] = { brand, airline, aircraft, reg, scale };
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast(`å·²å­˜å…¥ Catalogï¼š${sku}`,"good");
  }

  function deleteCatalogForSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
    if(!catalog[sku]){ toast("æ­¤ SKU ä¸åœ¨ Catalogã€‚","warn"); return; }

    delete catalog[sku];
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast(`å·²å¾ Catalog åˆªé™¤ï¼š${sku}`,"bad");
  }

  function resetDemo(){
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("å·²é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™ã€‚","good");
  }

  function wipeAll(){
    localStorage.removeItem(LS_KEYS.catalog);
    localStorage.removeItem(LS_KEYS.inventory);
    localStorage.removeItem(LS_KEYS.lastSave);
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    inventory = {};
    saveJSON(LS_KEYS.catalog, catalog);
    saveJSON(LS_KEYS.inventory, inventory);
    clearForm();
    renderInventory();
    updateKPIs();
    toast("å·²æ¸…é™¤å…¨éƒ¨è³‡æ–™ä¸¦å›åˆ°ç¯„ä¾‹ç‹€æ…‹ã€‚","bad");
  }

  /** ==========================
   *  Import / Export
   *  ========================== */
  function exportToBox(obj){
    el("exportBox").textContent = JSON.stringify(obj, null, 2);
  }

  function copyExport(){
    const txt = el("exportBox").textContent || "";
    navigator.clipboard.writeText(txt)
      .then(()=>toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚"))
      .catch(()=>toast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚","warn"));
  }

  function doExportCatalog(){
    exportToBox(catalog);
    toast("å·²åŒ¯å‡º Catalog åˆ°å³å´æ¡†ã€‚");
  }

  function doExportInventory(){
    exportToBox(inventory);
    toast("å·²åŒ¯å‡º Inventory åˆ°å³å´æ¡†ã€‚");
  }

  function parseJsonArea(){
    const raw = el("jsonArea").value.trim();
    if(!raw){ toast("è«‹å…ˆè²¼ä¸Š JSONã€‚","warn"); return null; }
    try{
      const obj = JSON.parse(raw);
      if(typeof obj !== "object" || obj === null){ toast("JSON å…§å®¹ä¸æ˜¯ç‰©ä»¶ã€‚","warn"); return null; }
      return obj;
    }catch(e){
      toast("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€—è™Ÿèˆ‡æ‹¬è™Ÿã€‚","bad");
      return null;
    }
  }

  function importCatalogFromArea(){
    const obj = parseJsonArea(); if(!obj) return;
    for(const [sku, v] of Object.entries(obj)){
      if(!v || typeof v !== "object"){ toast(`Catalog æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad"); return; }
      for(const k of ["brand","airline","aircraft","reg","scale"]){
        if(!(k in v)){ toast(`Catalog ç¼ºæ¬„ä½ï¼š${sku}.${k}`,"bad"); return; }
      }
    }
    catalog = obj;
    saveJSON(LS_KEYS.catalog, catalog);
    updateKPIs();
    setAutoInfoFromSKU();
    toast("å·²åŒ¯å…¥ Catalogï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
  }

  function importInventoryFromArea(){
    const obj = parseJsonArea(); if(!obj) return;
    for(const [sku, v] of Object.entries(obj)){
      if(!v || typeof v !== "object"){ toast(`Inventory æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad"); return; }
      if(!("qty" in v)){ toast(`Inventory ç¼º qtyï¼š${sku}`,"bad"); return; }
    }
    inventory = obj;
    saveJSON(LS_KEYS.inventory, inventory);
    renderInventory();
    updateKPIs();
    toast("å·²åŒ¯å…¥ Inventoryï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
  }

  /** ==========================
   *  Online lookup (no backend)
   *  ========================== */

  function toJinaUrl(url){
    // jina.ai è½‰è®€ï¼šæ”¯æ´ http/https
    if(url.startsWith("https://")) return JINA_PREFIX_S + url.replace("https://","");
    if(url.startsWith("http://")) return JINA_PREFIX + url.replace("http://","");
    return JINA_PREFIX_S + url;
  }

  async function fetchTextViaJina(url){
    const u = toJinaUrl(url);
    const resp = await fetch(u, { cache: "no-store" });
    if(!resp.ok) throw new Error(`Fetch failed ${resp.status}`);
    return await resp.text();
  }

  function extractBestGuessFromText(sku, text){
    // é€™è£¡æ˜¯ã€Œheuristic è§£æã€ï¼šå¾ HTML æ–‡å­—ä¸­æŠ“å¯èƒ½çš„å­—æ®µ
    // ç”±æ–¼å„ç«™ç‰ˆå‹ä¸åŒï¼Œå…ˆç”¨é€šç”¨è¦å‰‡æœ€å¤§åŒ–æˆåŠŸç‡ï¼š
    const t = (text || "").replace(/\s+/g, " ").trim();

    // scale: 1:200 / 1/200 / 1:400 / 1/400
    const scaleMatch = t.match(/(1\s*[:\/]\s*(?:200|400|500|300|144|72|150))/i);
    const scale = scaleMatch ? scaleMatch[1].replace(/\s+/g,"").replace("/",":") : "";

    // reg: å¸¸è¦‹æ©Ÿèº«ç·¨è™Ÿæ ¼å¼ï¼šJA702J / B-18210 / N123AA / HLxxxx / etc.
    const regMatch = t.match(/\b([A-Z]{1,3}-?[A-Z0-9]{3,6})\b/);
    const reg = regMatch ? regMatch[1] : "";

    // brand candidates
    const BRANDS = ["JC WINGS","J C WINGS","Jcwings","PHOENIX","GEMINI","HERPA","INFLIGHT","PANDA","SKY500","NG MODELS","AV400","AEROCLASSICS"];
    let brand = "";
    for(const b of BRANDS){
      const re = new RegExp(b.replace(/\s+/g,"\\s*"), "i");
      if(re.test(t)){ brand = b.replace(/\s+/g," ").toUpperCase().includes("JC") ? "JC Wings" : b; break; }
    }

    // aircraft: å¸¸è¦‹å‹è™Ÿ pattern
    const aircraftMatch =
      t.match(/\b(A3[0-9]{2}(?:-?[0-9]{2,3})?|A3[0-9]{2}neo|B7[0-9]{2}(?:-?[0-9]{2,3})?(?:ER|LR)?|B7[0-9]{2}(?:ER|LR)?|B7[0-9]{2}|B7[0-9]{2}-[0-9]{3}(?:ER|LR)?|B7[0-9]{2}-[0-9]{3}|B787-?(?:8|9|10)|B777-?(?:200|300)(?:ER)?|B747-?(?:200|300|400|8)(?:F)?|MD-?11|DC-?10|DC-?3|A220-?(?:100|300)|A350-?(?:900|1000)|A330-?(?:200|300)|A321neo|A320neo)\b/i);

    const aircraft = aircraftMatch ? normalizeAircraft(aircraftMatch[0]) : "";

    // airline: å¾ˆé›£é€šç”¨æŠ“ï¼Œå…ˆç”¨ä¸€å€‹ã€Œå¸¸è¦‹èˆªç©ºå…¬å¸å­—å…¸ã€ä¾†æ¯”å°ï¼ˆå¯æ“´å……ï¼‰
    const AIRLINES = [
      "JAPAN AIRLINES","JAL","ANA","ALL NIPPON AIRWAYS","EVA AIR","CHINA AIRLINES","CATHAY PACIFIC","SINGAPORE AIRLINES",
      "KOREAN AIR","ASIANA","DELTA","UNITED","AMERICAN AIRLINES","LUFTHANSA","SWISS","AIR FRANCE","KLM","QATAR AIRWAYS","EMIRATES","ETIHAD",
      "THAI AIRWAYS","VIETNAM AIRLINES","GARUDA","MALAYSIA AIRLINES","BRITISH AIRWAYS"
    ];
    let airline = "";
    for(const a of AIRLINES){
      const re = new RegExp("\\b" + a.replace(/\s+/g,"\\s+") + "\\b", "i");
      if(re.test(t)){
        airline = toNiceAirline(a);
        break;
      }
    }

    // å¦‚æœèƒ½åœ¨å…§å®¹é™„è¿‘æ‰¾åˆ° SKU æœ¬èº«ï¼Œä»£è¡¨çµæœç›¸é—œæ€§é«˜
    const hasSku = t.toUpperCase().includes(sku.toUpperCase());

    // å›å‚³ï¼šåªè¦æœ‰ä»»ä¸€å­—æ®µï¼Œå°±è¦–ç‚ºå€™é¸ï¼ˆä½†è¦é¿å…å…¨ç©ºï¼‰
    const any = Boolean(brand || airline || aircraft || reg || scale);
    return { ok: any, hasSku, product: { brand, airline, aircraft, reg, scale } };
  }

  function normalizeAircraft(s){
    return s.toUpperCase()
      .replace(/^B/,"Boeing ")
      .replace(/^A/,"Airbus ")
      .replace(/NEO/i,"neo")
      .replace(/\s+/g," ")
      .trim();
  }

  function toNiceAirline(a){
    const m = {
      "JAPAN AIRLINES":"Japan Airlines",
      "JAL":"Japan Airlines",
      "ALL NIPPON AIRWAYS":"All Nippon Airways",
      "ANA":"All Nippon Airways",
      "EVA AIR":"EVA Air",
      "CHINA AIRLINES":"China Airlines",
      "CATHAY PACIFIC":"Cathay Pacific",
      "SINGAPORE AIRLINES":"Singapore Airlines",
      "KOREAN AIR":"Korean Air",
      "ASIANA":"Asiana Airlines",
      "QATAR AIRWAYS":"Qatar Airways",
      "BRITISH AIRWAYS":"British Airways",
      "AIR FRANCE":"Air France"
    };
    return m[a] || a.split(" ").map(w => w[0] + w.slice(1).toLowerCase()).join(" ");
  }

  async function onlineLookupSKU(){
    const sku = normalizeSKU(el("skuInput").value);
    if(!sku){ toast("è«‹å…ˆè¼¸å…¥æˆ–æƒæ SKUã€‚","warn"); return; }

    // è‹¥ catalog å·²æœ‰ï¼Œå°±ä¸å¿…æŸ¥
    if(catalog[sku]){
      toast("Catalog å·²æœ‰æ­¤ SKUï¼Œç„¡éœ€ç·šä¸ŠæŸ¥è©¢ã€‚","good");
      setAutoInfoFromSKU();
      return;
    }

    el("lookupBtn").disabled = true;
    el("autoInfo").value = "ğŸ” ç·šä¸ŠæŸ¥è©¢ä¸­â€¦ï¼ˆä¾ç¶²è·¯é€Ÿåº¦å¯èƒ½éœ€ 2-10 ç§’ï¼‰";
    toast("é–‹å§‹ç·šä¸ŠæŸ¥è©¢â€¦","warn");

    const candidates = [];

    try{
      for(const src of LOOKUP_SOURCES){
        const urls = src.searchUrls(sku);
        for(const url of urls){
          try{
            const html = await fetchTextViaJina(url);
            const guess = extractBestGuessFromText(sku, html);
            if(guess.ok){
              candidates.push({ source: src.name, url, ...guess });
              // å¦‚æœå…§å®¹æ˜ç¢ºåŒ…å« skuï¼Œè€Œä¸”æŠ“åˆ° scale/aircraft ä¹‹é¡ï¼Œå„ªå…ˆæ—©åœ
              const p = guess.product;
              const strong = guess.hasSku && (p.aircraft || p.scale || p.reg);
              if(strong) break;
            }
          }catch(e){
            // å¿½ç•¥å–®ä¸€ url å¤±æ•—ï¼Œç¹¼çºŒä¸‹ä¸€å€‹
          }
        }
      }

      if(!candidates.length){
        el("autoInfo").value = "âŒ ç·šä¸ŠæŸ¥è©¢æ‰¾ä¸åˆ°ï¼ˆå¯èƒ½ç¶²ç«™ç‰ˆå‹/æœå°‹ç¶²å€è®Šäº†ï¼‰ã€‚å¯æ‰‹å‹•è¼¸å…¥å¾Œå­˜å…¥ Catalogã€‚";
        toast("ç·šä¸ŠæŸ¥è©¢æ‰¾ä¸åˆ°ã€‚","bad");
        return;
      }

      // é¸æœ€å¥½çš„ï¼šhasSku å„ªå…ˆï¼Œå†çœ‹å­—æ®µæ•¸é‡
      candidates.sort((a,b)=>{
        const score = (x)=> (x.hasSku?10:0) + countFields(x.product);
        return score(b) - score(a);
      });

      const best = candidates[0];
      const p = best.product;

      // è‹¥ airline/brand ç­‰é‚„æ˜¯ç©ºï¼Œä½† aircraft/scale/reg æœ‰å€¼ï¼Œä»å¯å…ˆå¡«å…¥è®“ä½ è£œä¸€é»é»
      fillManualFields(p);

      el("autoInfo").value = `âœ… ç·šä¸ŠæŸ¥è©¢ï¼ˆ${best.source}ï¼‰â†’ ${formatInfo(p)}ï¼ˆå»ºè­°æŒ‰ã€Œå­˜å…¥ Catalogã€ï¼‰`;
      toast(`ç·šä¸ŠæŸ¥è©¢æˆåŠŸï¼ˆ${best.source}ï¼‰ã€‚è«‹æŒ‰ã€Œå­˜å…¥ Catalogã€ä¿å­˜ã€‚`,"good");

    } finally {
      el("lookupBtn").disabled = false;
    }
  }

  function countFields(p){
    return ["brand","airline","aircraft","reg","scale"].reduce((n,k)=>n + (p?.[k] ? 1 : 0), 0);
  }

  /** ==========================
   *  Barcode scanner
   *  ========================== */
  let scanStream = null;
  let zxingReader = null;
  let scanRunning = false;

  function showScanModal(show){
    const m = el("scanModal");
    if(!m) return;
    m.classList.toggle("show", !!show);
    m.setAttribute("aria-hidden", show ? "false" : "true");
  }

  async function listCameras(){
    const sel = el("cameraSelect");
    sel.innerHTML = "";
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");

    if(!cams.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "æ‰¾ä¸åˆ°ç›¸æ©Ÿ";
      sel.appendChild(opt);
      return;
    }

    for(const c of cams){
      const opt = document.createElement("option");
      opt.value = c.deviceId;
      opt.textContent = c.label || `Camera ${sel.length+1}`;
      sel.appendChild(opt);
    }
  }

  function setScanStatus(msg){
    const s = el("scanStatus");
    if(s) s.textContent = msg;
  }

  function onDetected(code){
    const v = normalizeSKU(code);
    if(!v) return;
    el("skuInput").value = v;
    setAutoInfoFromSKU();
    toast(`å·²æƒæåˆ° SKUï¼š${v}`,"good");
    stopScan();
    showScanModal(false);
  }

  async function startScan(){
    if(scanRunning) return;

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      toast("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ APIã€‚è«‹æ”¹ç”¨ Chrome/Safariã€‚","bad");
      return;
    }

    showScanModal(true);
    setScanStatus("è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™â€¦");

    try{
      // å…ˆè¦ä¸€æ¬¡æ¬Šé™ï¼Œæ‰æ‹¿å¾—åˆ° device labelï¼ˆiOS/éƒ¨åˆ†ç€è¦½å™¨ï¼‰
      scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;

      await listCameras();
      const deviceId = el("cameraSelect").value || undefined;

      // å„ªå…ˆä½¿ç”¨ BarcodeDetector
      if("BarcodeDetector" in window){
        const formats = ["code_128","ean_13","ean_8","code_39","qr_code","upc_a","upc_e","itf"];
        const detector = new BarcodeDetector({ formats });

        scanStream = await navigator.mediaDevices.getUserMedia({
          video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment" },
          audio: false
        });

        const video = el("scanVideo");
        video.srcObject = scanStream;
        await video.play();
        scanRunning = true;
        setScanStatus("æƒæä¸­ï¼ˆBarcodeDetectorï¼‰â€¦");

        const tick = async () => {
          if(!scanRunning) return;
          try{
            const barcodes = await detector.detect(video);
            if(barcodes && barcodes.length){
              onDetected(barcodes[0].rawValue || "");
              return;
            }
          }catch(e){}
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);

      } else if (window.ZXingBrowser) {
        // ZXing fallback
        scanRunning = true;
        setScanStatus("æƒæä¸­ï¼ˆZXingï¼‰â€¦");

        zxingReader = new window.ZXingBrowser.BrowserMultiFormatReader();
        const video = el("scanVideo");
        // ZXing æœƒè‡ªå·±æŠ“ stream
        await zxingReader.decodeFromVideoDevice(deviceId || undefined, video, (result, err) => {
          if(result){
            onDetected(result.getText());
          }
        });

      } else {
        toast("æƒæåº«è¼‰å…¥å¤±æ•—ï¼ˆZXing æœªè¼‰å…¥ï¼‰ã€‚","bad");
        setScanStatus("æƒæåº«è¼‰å…¥å¤±æ•—ã€‚");
      }

    } catch (e) {
      console.error(e);
      toast("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼šå¯èƒ½æœªå…è¨±æ¬Šé™æˆ–è¢«å…§å»ºç€è¦½å™¨é˜»æ“‹ã€‚","bad");
      setScanStatus("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ã€‚");
      stopScan();
    }
  }

  function stopScan(){
    scanRunning = false;

    if(zxingReader){
      try{ zxingReader.reset(); }catch(e){}
      zxingReader = null;
    }

    const video = el("scanVideo");
    if(video){
      try{ video.pause(); }catch(e){}
      video.srcObject = null;
    }

    if(scanStream){
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;
    }

    setScanStatus("å·²åœæ­¢ã€‚");
  }

  safeBind("cameraSelect","change", async ()=>{
    // é‡æ–°å•Ÿå‹•ä»¥åˆ‡æ›ç›¸æ©Ÿ
    if(!el("scanModal").classList.contains("show")) return;
    stopScan();
    await startScan();
  });

  /** ==========================
   *  Bind events
   *  ========================== */
  safeBind("skuInput","input", setAutoInfoFromSKU);
  safeBind("skuInput","keydown", (e)=>{ if(e.key==="Enter") addOrUpdateInventory(); });

  safeBind("qtyInput","keydown", (e)=>{ if(e.key==="Enter") addOrUpdateInventory(); });

  safeBind("addBtn","click", addOrUpdateInventory);
  safeBind("sellBtn","click", sellInventory);
  safeBind("lookupBtn","click", onlineLookupSKU);

  safeBind("scanBtn","click", startScan);
  safeBind("closeScanBtn","click", ()=>{ stopScan(); showScanModal(false); });

  // é»èƒŒæ™¯é—œé–‰
  el("scanModal").addEventListener("click", (e)=>{
    if(e.target === el("scanModal")){
      stopScan();
      showScanModal(false);
    }
  });

  safeBind("clearFormBtn","click", clearForm);

  safeBind("saveCatalogBtn","click", saveCatalogForSKU);
  safeBind("deleteCatalogBtn","click", deleteCatalogForSKU);

  safeBind("searchInput","input", renderInventory);

  safeBind("exportCatalogBtn","click", ()=>{ exportToBox(catalog); toast("å·²åŒ¯å‡º Catalog åˆ°å³å´æ¡†ã€‚"); });
  safeBind("exportInventoryBtn","click", ()=>{ exportToBox(inventory); toast("å·²åŒ¯å‡º Inventory åˆ°å³å´æ¡†ã€‚"); });

  safeBind("importCatalogBtn","click", ()=>{ toast("æŠŠ Catalog JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ã€ã€‚","warn"); });
  safeBind("importInventoryBtn","click", ()=>{ toast("æŠŠ Inventory JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ã€ã€‚","warn"); });

  safeBind("doImportCatalogBtn","click", importCatalogFromArea);
  safeBind("doImportInventoryBtn","click", importInventoryFromArea);

  safeBind("copyExportBtn","click", copyExport);

  safeBind("resetDemoBtn","click", resetDemo);
  safeBind("wipeAllBtn","click", wipeAll);

  /** ==========================
   *  Init
   *  ========================== */
  updateSavePill();
  updateKPIs();
  setAutoInfoFromSKU();
  renderInventory();

  toast("å·²è¼‰å…¥å®Œæˆ âœ…","good");

});
</script>
</body>
</html>
