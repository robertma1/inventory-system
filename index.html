<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#223153;
      --accent:#60a5fa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, #1f3a8a55, transparent),
                  radial-gradient(900px 600px at 110% 10%, #0ea5e955, transparent),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 16px 10px;
      max-width: 1200px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-end; justify-content:space-between;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{margin:4px 0 0; color:var(--muted); font-size:12px}
    main{max-width:1200px; margin:0 auto; padding:10px 16px 28px; display:grid; gap:14px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd b{font-size:13px}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, textarea{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 10px;
      border-radius:10px;
      outline:none;
      font-size:16px; /* iPhone é¿å…è¼¸å…¥æ”¾å¤§ */
    }
    input:focus, textarea:focus{border-color:#3b82f6aa; box-shadow:0 0 0 4px #3b82f622}
    .field{flex:1; min-width:140px}
    .field.sm{flex:.55; min-width:120px}
    .field.lg{flex:1.6; min-width:220px}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
      font-size:13px;
      touch-action: manipulation;
    }
    button:hover{transform: translateY(-1px); border-color:#3b82f6aa}
    button.primary{background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#2563eb;}
    button.ghost{background:transparent}
    button.good{background: linear-gradient(180deg, #059669, #047857); border-color:#10b981}
    button.warn{background: linear-gradient(180deg, #d97706, #b45309); border-color:#f59e0b}
    button.bad{background: linear-gradient(180deg, #e11d48, #be123c); border-color:#fb7185}
    button.small{padding:8px 10px; font-size:12px}
    button:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }
    .status{font-size:12px; color:var(--muted); line-height:1.5}
    .status b{color:var(--text)}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
    }
    th{color:var(--muted); font-weight:700; text-align:left; background: rgba(255,255,255,.03)}
    tr:last-child td{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.03);
      min-width: 150px;
    }
    .kpi .box .n{font-size:18px; font-weight:800}
    .kpi .box .t{font-size:12px; color:var(--muted)}
    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(17,26,46,.95);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      display:none;
      font-size:13px;
      line-height:1.5;
      z-index: 9999;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .toast.show{display:block}
    .toast.good{border-color:#10b98177}
    .toast.warn{border-color:#f59e0b77}
    .toast.bad{border-color:#fb718577}
    .help{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 740px){ .split{grid-template-columns:1fr} }
    .pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      color: #cbd5e1;
      max-height: 240px;
      overflow:auto;
    }
    .hintline{
      margin-top:8px;
      padding:8px 10px;
      border:1px dashed #33507f;
      border-radius:12px;
      background: rgba(96,165,250,.06);
      color:#cbd5e1;
      font-size:12px;
      line-height:1.5;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>é£›æ©Ÿæ¨¡å‹åº«å­˜ç®¡ç†ï¼ˆæœ¬æ©Ÿç‰ˆï¼‰</h1>
    <div class="sub">è¼¸å…¥ã€Œè²¨è™Ÿ + æ•¸é‡ã€â†’ è‡ªå‹•è¾¨è­˜å“ç‰Œ/èˆªç©ºå…¬å¸/æ©Ÿå‹/æ©Ÿèº«ç·¨è™Ÿ/æ¯”ä¾‹ï¼›è³‡æ–™å­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼Œä¸éœ€å¾Œç«¯ã€‚</div>
  </div>
  <div class="pill">âœ… localStorage è‡ªå‹•ä¿å­˜</div>
</header>

<main>
  <div class="card">
    <div class="hd">
      <b>ç¸½è¦½</b>
      <div class="pill" id="savePill">æœ€è¿‘ä¿å­˜ï¼šâ€”</div>
    </div>
    <div class="bd">
      <div class="kpi">
        <div class="box">
          <div class="n" id="kpiInventoryItems">0</div>
          <div class="t">åº«å­˜å“é …æ•¸ï¼ˆSKUï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiTotalQty">0</div>
          <div class="t">åº«å­˜ç¸½æ•¸é‡ï¼ˆQty åŠ ç¸½ï¼‰</div>
        </div>
        <div class="box">
          <div class="n" id="kpiCatalogCount">0</div>
          <div class="t">Catalog è²¨è™Ÿç­†æ•¸</div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Left -->
    <section class="card">
      <div class="hd">
        <b>æ–°å¢ / æ›´æ–°åº«å­˜</b>
        <span class="pill">è¼¸å…¥è²¨è™Ÿè‡ªå‹•å¸¶å‡º</span>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field sm">
            <label>è²¨è™Ÿï¼ˆSKUï¼‰</label>
            <input id="skuInput" class="mono" placeholder="ä¾‹å¦‚ï¼šSA2043" autocomplete="off" />
          </div>
          <div class="field sm">
            <label>æ•¸é‡ï¼ˆQtyï¼‰</label>
            <input id="qtyInput" type="number" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š3" />
          </div>
          <div class="field lg">
            <label>è¾¨è­˜çµæœï¼ˆè‡ªå‹•ï¼‰</label>
            <input id="autoInfo" placeholder="è¼¸å…¥ SKU å¾Œé¡¯ç¤ºâ€¦" readonly />
          </div>
          <div class="field sm">
            <label>ç·šä¸ŠæŸ¥è©¢ï¼ˆå¤šä¾†æºï¼‰</label>
            <button class="primary small" id="onlineLookupBtn" title="ScaleModelStore / WingsWorld / AviationMegastore">ç·šä¸ŠæŸ¥è©¢</button>
          </div>
        </div>

        <div class="hintline" id="lookupHint">
          ä¾†æºé †åºï¼šScaleModelStore â†’ WingsWorld â†’ AviationMegastoreã€‚<br/>
          è‹¥é¡¯ç¤ºã€ŒæŸ¥ä¸åˆ°ã€ä½†ä½ ç¢ºå®šç¶²ç«™æœ‰ï¼šå¤šåŠæ˜¯æœå°‹å›å‚³è·³è½‰é€£çµæˆ–ç¶²ç«™æ ¼å¼è®Šå‹•ï¼›ä½ å¯ä»¥æŠŠè©²å•†å“é ç¶²å€è²¼çµ¦æˆ‘ï¼Œæˆ‘å†å¹«ä½ æŠŠè§£æè¦å‰‡èª¿æº–ã€‚
        </div>

        <div class="btns">
          <button class="primary" id="addBtn">åŠ å…¥ / æ›´æ–°åº«å­˜</button>
          <button class="ghost" id="clearFormBtn">æ¸…ç©ºè¼¸å…¥</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

        <div class="split">
          <div>
            <b class="small">è£œé½Šè³‡æ–™ â†’ å­˜å…¥ Catalogï¼ˆSKU å°ç…§è¡¨ï¼‰</b>
            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>å“ç‰Œ</label>
                <input id="brandInput" placeholder="JC Wings" />
              </div>
              <div class="field">
                <label>èˆªç©ºå…¬å¸</label>
                <input id="airlineInput" placeholder="Japan Airlines" />
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>æ©Ÿå‹</label>
                <input id="typeInput" placeholder="Boeing 777-200ER" />
              </div>
              <div class="field">
                <label>æ©Ÿèº«ç·¨è™Ÿï¼ˆRegï¼‰</label>
                <input id="regInput" class="mono" placeholder="JA702J" />
              </div>
              <div class="field sm">
                <label>æ¯”ä¾‹</label>
                <input id="scaleInput" class="mono" placeholder="1:200" />
              </div>
            </div>
            <div class="btns">
              <button class="good" id="saveCatalogBtn">å­˜å…¥ Catalog</button>
              <button class="warn" id="deleteCatalogBtn">å¾ Catalog åˆªé™¤æ­¤ SKU</button>
            </div>
            <div class="help">æç¤ºï¼šCatalog æ˜¯ã€ŒSKU â†’ å•†å“è³‡è¨Šã€çš„å°ç…§è¡¨ã€‚ä½ å¯ä»¥å…ˆæŠŠå¸¸ç”¨è²¨è™Ÿå»ºç«‹èµ·ä¾†ï¼Œä¹‹å¾Œå°±å®Œå…¨è‡ªå‹•åŒ–ã€‚</div>
          </div>

          <div>
            <b class="small">å¿«é€Ÿå»ºç«‹ï¼ˆç¯„ä¾‹ï¼‰</b>
            <div class="help">å…§å»ºä¸€ç­†ï¼š<span class="mono">SA2043</span>ã€‚å¯ç”¨ä¸‹é¢æŒ‰éˆ•é‡ç½®å›ç¯„ä¾‹è³‡æ–™ã€‚</div>
            <div class="btns">
              <button id="resetDemoBtn">é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™</button>
              <button class="bad" id="wipeAllBtn">æ¸…é™¤å…¨éƒ¨è³‡æ–™ï¼ˆCatalog+Inventoryï¼‰</button>
            </div>
            <div class="help">âš ï¸ã€Œæ¸…é™¤å…¨éƒ¨ã€æœƒæŠŠç€è¦½å™¨ä¿å­˜çš„è³‡æ–™éƒ½åˆªæ‰ï¼ˆç„¡æ³•å¾©åŸï¼‰ã€‚</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="hd">
        <b>åº«å­˜æ¸…å–®</b>
        <div class="row" style="gap:8px; align-items:center">
          <input id="searchInput" placeholder="æœå°‹ï¼šSKU / èˆªç©ºå…¬å¸ / æ©Ÿå‹ / Regâ€¦" style="width:280px; max-width: 52vw;" />
          <button id="exportInventoryBtn">åŒ¯å‡º Inventory JSON</button>
        </div>
      </div>

      <div class="bd">
        <!-- Sell -->
        <div class="card" style="border-radius:12px; margin-bottom:12px; border-color:#31446f; box-shadow:none;">
          <div class="hd" style="border-bottom-color:#31446f;">
            <b>å”®å‡º / æ‰£åº«å­˜</b>
            <span class="pill">ä¸æœƒæ‰£åˆ°è² æ•¸</span>
          </div>
          <div class="bd">
            <div class="row">
              <div class="field sm">
                <label>SKU</label>
                <input id="sellSkuInput" class="mono" placeholder="ä¾‹å¦‚ï¼šSA2043" />
              </div>
              <div class="field sm">
                <label>å”®å‡ºæ•¸é‡</label>
                <input id="sellQtyInput" type="number" min="1" step="1" placeholder="ä¾‹å¦‚ï¼š1" />
              </div>
              <div class="field lg">
                <label>å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
                <input id="sellNoteInput" placeholder="ä¾‹å¦‚ï¼šè¦çš®è¨‚å–® #12345 / é¢äº¤" />
              </div>
            </div>
            <div class="btns">
              <button class="warn" id="sellBtn">ç¢ºèªå”®å‡ºï¼ˆæ‰£åº«å­˜ï¼‰</button>
              <button class="ghost" id="copySkuBtn">ä½¿ç”¨ä¸Šæ–¹ SKU</button>
              <button class="ghost" id="clearSellBtn">æ¸…ç©º</button>
            </div>
          </div>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:90px">SKU</th>
                <th style="min-width:100px">å“ç‰Œ</th>
                <th style="min-width:140px">èˆªç©ºå…¬å¸</th>
                <th style="min-width:160px">æ©Ÿå‹</th>
                <th style="min-width:100px">Reg</th>
                <th style="min-width:80px">æ¯”ä¾‹</th>
                <th class="right" style="min-width:120px">æ•¸é‡</th>
                <th class="right" style="min-width:160px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="invBody">
              <tr><td colspan="8" class="muted">å°šç„¡åº«å­˜ã€‚è«‹åœ¨å·¦å´æ–°å¢ã€‚</td></tr>
            </tbody>
          </table>
        </div>

        <div class="btns" style="margin-top:12px">
          <button class="warn" id="importInventoryBtn">åŒ¯å…¥ Inventory JSON</button>
          <button id="exportCatalogBtn">åŒ¯å‡º Catalog JSON</button>
          <button class="warn" id="importCatalogBtn">åŒ¯å…¥ Catalog JSON</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:14px 0"/>

        <b class="small">äº¤æ˜“ç´€éŒ„ï¼ˆæœ€è¿‘ 50 ç­†ï¼‰</b>
        <div class="pre" id="txBox" style="margin-top:8px">ï¼ˆå°šç„¡ï¼‰</div>

        <div class="help">
          å°æŠ€å·§ï¼šå¦‚æœç·šä¸ŠæŸ¥è©¢æŠ“åˆ°è³‡è¨Šï¼Œè¨˜å¾—æŒ‰ã€Œå­˜å…¥ Catalogã€ï¼Œä¹‹å¾Œå°±èƒ½å®Œå…¨é›¢ç·šè‡ªå‹•è¾¨è­˜ã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- Import / Export -->
  <section class="card">
    <div class="hd">
      <b>åŒ¯å…¥ / åŒ¯å‡ºå…§å®¹</b>
      <span class="pill">JSONï¼ˆå¯å‚™ä»½/æ¬å®¶ï¼‰</span>
    </div>
    <div class="bd">
      <div class="split">
        <div>
          <label>è²¼ä¸Šè¦åŒ¯å…¥çš„ JSONï¼ˆCatalog æˆ– Inventoryï¼‰</label>
          <textarea id="jsonArea" rows="8" placeholder='è²¼ä¸Š JSON å¾Œå†æŒ‰ã€ŒåŒ¯å…¥ã€'></textarea>
          <div class="btns">
            <button class="warn" id="doImportCatalogBtn">æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
            <button class="warn" id="doImportInventoryBtn">æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ï¼ˆè¦†è“‹ï¼‰</button>
          </div>
          <div class="help">æ³¨æ„ï¼šåŒ¯å…¥æœƒè¦†è“‹ç›®å‰è³‡æ–™ã€‚å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
        </div>
        <div>
          <label>åŒ¯å‡ºçµæœï¼ˆæœƒé¡¯ç¤ºåœ¨ä¸‹é¢ï¼Œå¯ç›´æ¥è¤‡è£½ä¿å­˜ï¼‰</label>
          <div class="pre" id="exportBox">{}</div>
          <div class="btns">
            <button id="copyExportBtn">è¤‡è£½åŒ¯å‡ºå…§å®¹</button>
          </div>
          <div class="help">ä½ ä¹Ÿå¯ä»¥æŠŠåŒ¯å‡ºè²¼åˆ° Notion/Google Doc åšå‚™ä»½ã€‚</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="hd"><b>å¦‚ä½•ä½¿ç”¨ï¼ˆGitHub Pagesï¼‰</b></div>
    <div class="bd status">
      âœ… GitHub Pages æœƒè‡ªå‹•è¼‰å…¥æ ¹ç›®éŒ„çš„ <b>index.html</b>ã€‚è«‹æŠŠé€™ä»½æª”æ¡ˆå‘½åç‚º <b>index.html</b>ã€‚<br/>
      1) Repo æ ¹ç›®éŒ„æ”¾ index.html â†’ Settings â†’ Pages â†’ Branch é¸ main / root â†’ Save<br/>
      2) é–‹å•Ÿç¶²å€ï¼š<span class="mono">https://ä½ çš„å¸³è™Ÿ.github.io/ä½ çš„repo/</span><br/>
      3) è¼¸å…¥ SKUï¼ˆä¾‹å¦‚ <span class="mono">SA2043</span>ï¼‰ã€‚è‹¥ Catalog æ‰¾ä¸åˆ°ï¼Œå¯æŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ã€æŠ“å–ä¸¦è‡ªå‹•å¡«å…¥æ¬„ä½ã€‚<br/>
      4) æŸ¥åˆ°å¾ŒæŒ‰ã€Œå­˜å…¥ Catalogã€ä¿å­˜ â†’ ä¸‹æ¬¡åŒ SKU å°±å®Œå…¨é›¢ç·šè‡ªå‹•è¾¨è­˜ã€‚<br/>
      5) ä»»ä½•è®Šæ›´éƒ½æœƒè‡ªå‹•ä¿å­˜åˆ°ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚è¦æ›é›»è…¦/å‚™ä»½ï¼šç”¨ã€ŒåŒ¯å‡º JSONã€ã€‚<br/>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
/** ==========================
 *  GitHub Pages / Debug Safety
 *  - å¦‚æœ JS ç™¼ç”ŸéŒ¯èª¤ï¼Œä¸è¦ã€ŒæŒ‰éˆ•éƒ½æ²’åæ‡‰ã€
 *  - æœƒç”¨ toast é¡¯ç¤ºéŒ¯èª¤ï¼Œæ–¹ä¾¿ä½ åœ¨æ‰‹æ©Ÿä¸Šä¹Ÿçœ‹å¾—åˆ°
 *  ========================== */
window.addEventListener("error", (e)=>{
  try{
    const msg = (e && e.message) ? e.message : "Unknown error";
    toast("âš ï¸ JS ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + msg, "bad");
  }catch(_){}
});
window.addEventListener("unhandledrejection", (e)=>{
  try{
    const msg = (e && e.reason && e.reason.message) ? e.reason.message : String(e.reason || "Promise rejected");
    toast("âš ï¸ éé æœŸéŒ¯èª¤ï¼š\n" + msg, "bad");
  }catch(_){}
});

/** ==========================
 *  Local storage schema
 *  catalog: { [sku]: {brand, airline, aircraft, reg, scale, source?, url?} }
 *  inventory: { [sku]: {qty, brand, airline, aircraft, reg, scale, updatedAt} }
 *  tx: [{ts,type,sku,delta,qtyAfter,note}]
 *  ========================== */

const LS_KEYS = {
  catalog: "rf_catalog_v3",
  inventory: "rf_inventory_v3",
  lastSave: "rf_last_save_v3",
  tx: "rf_tx_v2"
};

// Demo catalog
const DEMO_CATALOG = {
  "SA2043": {
    brand: "JC Wings",
    airline: "Japan Airlines",
    aircraft: "Boeing 777-200ER",
    reg: "JA702J",
    scale: "1:200",
    source: "demo",
    url: ""
  }
};

function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    return fallback;
  }
}

function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
  localStorage.setItem(LS_KEYS.lastSave, nowStamp());
  updateSavePill();
}

let catalog = loadJSON(LS_KEYS.catalog, null);
let inventory = loadJSON(LS_KEYS.inventory, null);
let tx = loadJSON(LS_KEYS.tx, null);

function ensureInit(){
  if(!catalog || typeof catalog !== "object"){
    catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
    saveJSON(LS_KEYS.catalog, catalog);
  }
  if(!inventory || typeof inventory !== "object"){
    inventory = {};
    saveJSON(LS_KEYS.inventory, inventory);
  }
  if(!Array.isArray(tx)){
    tx = [];
    saveJSON(LS_KEYS.tx, tx);
  }
}
ensureInit();

/** ==========================
 *  UI helpers
 *  ========================== */
const el = id => document.getElementById(id);

function toast(msg, type="good"){
  const t = el("toast");
  t.className = `toast show ${type}`;
  t.textContent = msg;
  setTimeout(()=>{ t.className = "toast"; }, 3400);
}

function normalizeSKU(s){ return (s || "").trim().toUpperCase(); }

function formatInfo(p){
  if(!p) return "";
  return `${p.brand}ï½œ${p.airline}ï½œ${p.aircraft}ï½œ${p.reg}ï½œ${p.scale}`;
}

function updateSavePill(){
  const stamp = localStorage.getItem(LS_KEYS.lastSave) || "â€”";
  el("savePill").textContent = `æœ€è¿‘ä¿å­˜ï¼š${stamp}`;
}

function updateKPIs(){
  const invKeys = Object.keys(inventory || {});
  el("kpiInventoryItems").textContent = invKeys.length;

  let total = 0;
  invKeys.forEach(k => total += Number(inventory[k].qty || 0));
  el("kpiTotalQty").textContent = total;

  el("kpiCatalogCount").textContent = Object.keys(catalog || {}).length;
}

function setAutoInfoFromSKU(){
  const sku = normalizeSKU(el("skuInput").value);
  if(!sku){
    el("autoInfo").value = "";
    return;
  }
  const p = catalog[sku];
  if(p){
    el("autoInfo").value = "âœ… " + formatInfo(p);
    el("brandInput").value = p.brand || "";
    el("airlineInput").value = p.airline || "";
    el("typeInput").value = p.aircraft || "";
    el("regInput").value = p.reg || "";
    el("scaleInput").value = p.scale || "";
  }else{
    el("autoInfo").value = "âš ï¸ Catalog æ‰¾ä¸åˆ°æ­¤ SKUï¼Œå¯æŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ã€è‡ªå‹•æŠ“å–ï¼Œæˆ–åœ¨ä¸‹æ–¹è£œé½Šå¾Œå­˜å…¥ã€‚";
  }
}

function clearForm(){
  el("skuInput").value = "";
  el("qtyInput").value = "";
  el("autoInfo").value = "";
  el("brandInput").value = "";
  el("airlineInput").value = "";
  el("typeInput").value = "";
  el("regInput").value = "";
  el("scaleInput").value = "";
}

function clearSell(){
  el("sellSkuInput").value = "";
  el("sellQtyInput").value = "";
  el("sellNoteInput").value = "";
}

function copyTopSkuToSell(){
  el("sellSkuInput").value = normalizeSKU(el("skuInput").value);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ==========================
 *  Transactions
 *  ========================== */
function pushTx({type, sku, delta, qtyAfter, note=""}){
  tx.unshift({
    ts: nowStamp(),
    type,
    sku,
    delta,
    qtyAfter,
    note
  });
  tx = tx.slice(0, 50);
  saveJSON(LS_KEYS.tx, tx);
  renderTx();
}

function renderTx(){
  if(!tx.length){
    el("txBox").textContent = "ï¼ˆå°šç„¡ï¼‰";
    return;
  }
  el("txBox").textContent = tx.map(t=>{
    const sign = t.delta > 0 ? "+" : "";
    return `${t.ts}  [${t.type}]  ${t.sku}  ${sign}${t.delta}  -> Qty ${t.qtyAfter}${t.note ? "  | " + t.note : ""}`;
  }).join("\n");
}

/** ==========================
 *  Inventory ops
 *  ========================== */
function addOrUpdateInventory(){
  const sku = normalizeSKU(el("skuInput").value);
  const qty = Math.floor(Number(el("qtyInput").value));

  if(!sku){
    toast("è«‹å…ˆè¼¸å…¥ SKUï¼ˆè²¨è™Ÿï¼‰ã€‚","warn");
    return;
  }
  if(!Number.isFinite(qty) || qty < 0){
    toast("è«‹è¼¸å…¥æ­£ç¢ºçš„æ•¸é‡ï¼ˆ0 ä»¥ä¸Šæ•´æ•¸ï¼‰ã€‚","warn");
    return;
  }
  const p = catalog[sku];
  if(!p){
    toast("æ­¤ SKU å°šæœªå»ºç«‹ Catalogã€‚å¯å…ˆæŒ‰ã€Œç·šä¸ŠæŸ¥è©¢ã€æˆ–æ‰‹å‹•è£œé½Šå¾Œå­˜å…¥ã€‚","warn");
    return;
  }

  const prev = inventory[sku]?.qty ?? null;

  inventory[sku] = {
    sku,
    qty,
    brand: p.brand || "",
    airline: p.airline || "",
    aircraft: p.aircraft || "",
    reg: p.reg || "",
    scale: p.scale || "",
    updatedAt: nowStamp()
  };

  saveJSON(LS_KEYS.inventory, inventory);
  renderInventory();
  updateKPIs();

  if(prev === null){
    pushTx({type:"ADD", sku, delta: qty, qtyAfter: qty, note:"ï¼ˆæ–°å¢åº«å­˜ï¼‰"});
  }else{
    const delta = qty - Number(prev);
    pushTx({type:"SET", sku, delta, qtyAfter: qty, note:"ï¼ˆè¨­å®šåº«å­˜ï¼‰"});
  }

  toast(`å·²æ›´æ–°åº«å­˜ï¼š${sku}ï¼ˆQty = ${qty}ï¼‰`);
}

function deleteInventorySKU(sku){
  const prev = Number(inventory[sku]?.qty || 0);
  delete inventory[sku];
  saveJSON(LS_KEYS.inventory, inventory);
  renderInventory();
  updateKPIs();
  pushTx({type:"DEL", sku, delta: -prev, qtyAfter: 0, note:"ï¼ˆåˆªé™¤åº«å­˜é …ç›®ï¼‰"});
  toast(`å·²åˆªé™¤åº«å­˜ï¼š${sku}`,"bad");
}

function adjustQty(sku, delta){
  const item = inventory[sku];
  if(!item) return;
  const prev = Number(item.qty || 0);
  const next = Math.max(0, prev + delta);
  const applied = next - prev;
  if(applied === 0) return;

  item.qty = next;
  item.updatedAt = nowStamp();

  saveJSON(LS_KEYS.inventory, inventory);
  renderInventory();
  updateKPIs();
  pushTx({type: applied>0?"INC":"DEC", sku, delta: applied, qtyAfter: next, note:"ï¼ˆå¿«æ·æŒ‰éˆ•ï¼‰"});
}

function sellDeduct(){
  const sku = normalizeSKU(el("sellSkuInput").value);
  const qty = Math.floor(Number(el("sellQtyInput").value));
  const note = (el("sellNoteInput").value || "").trim();

  if(!sku){ toast("è«‹å…ˆè¼¸å…¥å”®å‡ºçš„ SKUã€‚","warn"); return; }
  if(!Number.isFinite(qty) || qty <= 0){ toast("å”®å‡ºæ•¸é‡éœ€ç‚º 1 ä»¥ä¸Šæ•´æ•¸ã€‚","warn"); return; }

  const item = inventory[sku];
  if(!item){ toast("æ­¤ SKU ç›®å‰ä¸åœ¨åº«å­˜æ¸…å–®ä¸­ã€‚","warn"); return; }

  const prev = Number(item.qty || 0);
  if(qty > prev){
    toast(`åº«å­˜ä¸è¶³ï¼š${sku} ç›®å‰ ${prev}ï¼Œç„¡æ³•æ‰£ ${qty}`,"bad");
    return;
  }

  const next = prev - qty;
  item.qty = next;
  item.updatedAt = nowStamp();

  saveJSON(LS_KEYS.inventory, inventory);
  renderInventory();
  updateKPIs();

  pushTx({type:"SELL", sku, delta: -qty, qtyAfter: next, note: note || "ï¼ˆå”®å‡ºï¼‰"});
  toast(`å·²å”®å‡ºï¼š${sku} -${qty}ï¼ˆå‰©é¤˜ Qty = ${next}ï¼‰`, "warn");

  el("sellQtyInput").value = "";
  el("sellNoteInput").value = "";
}

function renderInventory(){
  const q = (el("searchInput").value || "").trim().toLowerCase();
  const keys = Object.keys(inventory || {}).sort((a,b)=>a.localeCompare(b));

  const rows = [];
  for(const sku of keys){
    const it = inventory[sku];
    const hay = [sku, it.brand, it.airline, it.aircraft, it.reg, it.scale].join(" ").toLowerCase();
    if(q && !hay.includes(q)) continue;

    rows.push(`
      <tr>
        <td class="mono"><b>${sku}</b><div class="muted small">${it.updatedAt || ""}</div></td>
        <td>${escapeHtml(it.brand)}</td>
        <td>${escapeHtml(it.airline)}</td>
        <td>${escapeHtml(it.aircraft)}</td>
        <td class="mono">${escapeHtml(it.reg)}</td>
        <td class="mono">${escapeHtml(it.scale)}</td>
        <td class="right"><b>${Number(it.qty || 0)}</b></td>
        <td class="right">
          <button onclick="window.__dec('${sku}')" title="-1">-</button>
          <button onclick="window.__inc('${sku}')" title="+1">+</button>
          <button class="bad" onclick="window.__del('${sku}')" title="åˆªé™¤">åˆªé™¤</button>
        </td>
      </tr>
    `);
  }

  el("invBody").innerHTML = rows.length
    ? rows.join("")
    : `<tr><td colspan="8" class="muted">æ²’æœ‰ç¬¦åˆçš„çµæœã€‚</td></tr>`;
}

// expose for inline buttons
window.__inc = (sku)=>adjustQty(sku, +1);
window.__dec = (sku)=>adjustQty(sku, -1);
window.__del = (sku)=>deleteInventorySKU(sku);

/** ==========================
 *  Catalog ops
 *  ========================== */
function saveCatalogForSKU(){
  const sku = normalizeSKU(el("skuInput").value);
  if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUï¼Œæ‰èƒ½å­˜å…¥ Catalogã€‚","warn"); return; }

  const brand = el("brandInput").value.trim();
  const airline = el("airlineInput").value.trim();
  const aircraft = el("typeInput").value.trim();
  const reg = el("regInput").value.trim();
  const scale = el("scaleInput").value.trim();

  if(!brand || !airline || !aircraft || !reg || !scale){
    toast("è«‹è£œé½Šå“ç‰Œ/èˆªç©ºå…¬å¸/æ©Ÿå‹/Reg/æ¯”ä¾‹ï¼Œå†å­˜å…¥ Catalogã€‚","warn");
    return;
  }

  const prev = catalog[sku];
  catalog[sku] = {
    ...(prev || {}),
    brand, airline, aircraft, reg, scale
  };

  saveJSON(LS_KEYS.catalog, catalog);
  updateKPIs();
  setAutoInfoFromSKU();
  toast(`å·²å­˜å…¥ Catalogï¼š${sku}`,"good");
}

function deleteCatalogForSKU(){
  const sku = normalizeSKU(el("skuInput").value);
  if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKUã€‚","warn"); return; }
  if(!catalog[sku]){ toast("æ­¤ SKU ä¸åœ¨ Catalogã€‚","warn"); return; }

  delete catalog[sku];
  saveJSON(LS_KEYS.catalog, catalog);
  setAutoInfoFromSKU();
  updateKPIs();
  toast(`å·²å¾ Catalog åˆªé™¤ï¼š${sku}`,"bad");
}

/** ==========================
 *  Online lookup (Multi-source)
 *  - GitHub Pages friendly: ALWAYS use HTTPS proxy (avoid Mixed Content)
 *  - uses r.jina.ai as a text-proxy + DuckDuckGo HTML search
 *  - Order: ScaleModelStore -> WingsWorld -> AviationMegastore
 *  ========================== */
const JINA_PREFIX_HTTPS = "https://r.jina.ai/https://";

async function onlineLookup(){
  const btn = el("onlineLookupBtn");
  const sku = normalizeSKU(el("skuInput").value);

  if(!sku){ toast("è«‹å…ˆè¼¸å…¥ SKU å†æŸ¥è©¢ã€‚","warn"); return; }
  if(catalog[sku]){ toast("æ­¤ SKU å·²åœ¨ Catalogï¼Œç„¡éœ€ç·šä¸ŠæŸ¥è©¢ã€‚"); return; }

  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "æŸ¥è©¢ä¸­â€¦";

  try{
    // 1) ScaleModelStore
    btn.textContent = "æŸ¥è©¢ä¸­â€¦(ScaleModelStore)";
    const sm = await lookupScaleModelStore(sku);
    if(sm){
      applyLookupResult(sku, sm);
      return;
    }

    // 2) WingsWorld
    btn.textContent = "æŸ¥è©¢ä¸­â€¦(WingsWorld)";
    const ww = await lookupWingsWorld(sku);
    if(ww){
      applyLookupResult(sku, ww);
      return;
    }

    // 3) AviationMegastore (best-effort)
    btn.textContent = "æŸ¥è©¢ä¸­â€¦(AviationMegastore)";
    const am = await lookupAviationMegastore(sku);
    if(am){
      applyLookupResult(sku, am);
      return;
    }

    toast("å¤šä¾†æºéƒ½æŸ¥ä¸åˆ°æ­¤ SKUã€‚å¯èƒ½åŸå› ï¼šæœå°‹æ²’æ”¶éŒ„ / è½‰å€æ ¼å¼æ”¹è®Š / ç¶²ç«™é é¢çµæ§‹æ”¹ç‰ˆã€‚","warn");
  }catch(e){
    console.error(e);
    toast("ç·šä¸ŠæŸ¥è©¢å¤±æ•—ï¼ˆå¯èƒ½ç¶²è·¯/ä»£ç†/ç¶²ç«™é™åˆ¶ï¼‰ã€‚\n" + (e?.message || ""), "bad");
  }finally{
    btn.disabled = false;
    btn.textContent = oldText;
  }
}

function applyLookupResult(sku, result){
  el("brandInput").value = result.brand || "";
  el("airlineInput").value = result.airline || "";
  el("typeInput").value = result.aircraft || "";
  el("regInput").value = result.reg || "";
  el("scaleInput").value = result.scale || "";

  el("autoInfo").value = `ğŸŒ ${result.source || "Online"}ï½œ${result.url ? result.url : ""}\n${result.brand}ï½œ${result.airline}ï½œ${result.aircraft}ï½œ${result.reg}ï½œ${result.scale}`;
  toast(`å·²ç·šä¸ŠæŠ“å–ï¼ˆ${result.source}ï¼‰ï¼Œè«‹æŒ‰ã€Œå­˜å…¥ Catalogã€ä¿å­˜ã€‚`, "good");

  // draft into catalog (not auto-save to avoid silent bad data)
  catalog[sku] = {
    ...(catalog[sku] || {}),
    brand: result.brand || "",
    airline: result.airline || "",
    aircraft: result.aircraft || "",
    reg: result.reg || "",
    scale: result.scale || "",
    source: result.source || "",
    url: result.url || ""
  };
}

/** ---------- Shared: DDG search + URL extraction (handles uddg redirects) ---------- */
async function ddgSearchFirstUrlByDomain(query, domain){
  const ddgUrl = `${JINA_PREFIX_HTTPS}duckduckgo.com/html/?q=${encodeURIComponent(query)}`;
  const ddgText = await (await fetch(ddgUrl, {cache:"no-store"})).text();
  return extractFirstDomainLinkFromDDGText(ddgText, domain);
}

function extractFirstDomainLinkFromDDGText(text, domain){
  const directRe = new RegExp(`https?:\\/\\/(www\\.)?${escapeRegex(domain)}\\/[^\\s<>"']+`, "i");
  let m = text.match(directRe);
  if(m) return tidyUrl(m[0]);

  const uddgMatches = [...text.matchAll(/uddg=([^&\s<>"']+)/gi)];
  for(const um of uddgMatches){
    try{
      const decoded = decodeURIComponent(um[1]);
      const re = new RegExp(`https?:\\/\\/(www\\.)?${escapeRegex(domain)}\\/`, "i");
      if(re.test(decoded)){
        return tidyUrl(decoded);
      }
    }catch(e){}
  }
  return null;
}

function tidyUrl(url){
  return (url || "").replace(/[)\]]+$/,"").trim();
}

function escapeRegex(s){
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

/** ---------- Source 1: ScaleModelStore ---------- */
async function lookupScaleModelStore(sku){
  const q = `site:scalemodelstore.com/model ${sku}`;
  const url = await ddgSearchFirstUrlByDomain(q, "scalemodelstore.com");
  if(!url) return null;

  const text = await fetchTextViaJina(url);
  const parsed = parseScaleModelStoreText(text, sku);
  if(!parsed) return null;

  return { ...parsed, source: "ScaleModelStore", url };
}

/** ---------- Fetch via Jina (HTTPS only) ---------- */
async function fetchTextViaJina(url){
  // always use HTTPS proxy to avoid mixed-content issues on GitHub Pages
  if(!/^https:\/\//i.test(url)){
    // if any http slipped in, upgrade it
    url = url.replace(/^http:\/\//i, "https://");
  }
  const clean = url.replace(/^https:\/\//i,"");
  const proxyUrl = JINA_PREFIX_HTTPS + clean;
  const resp = await fetch(proxyUrl, {cache:"no-store"});
  if(!resp.ok) throw new Error(`Jina fetch failed: ${resp.status}`);
  return await resp.text();
}

function parseScaleModelStoreText(text, sku){
  const t = (text || "").replace(/\r/g,"");

  const h3 = [...t.matchAll(/^###\s+(.+)$/gm)].map(m=>m[1].trim());
  const airline = h3[0] || "";
  const aircraft = h3[1] || "";

  const brand = pickAfterLabel(t, "Brand:");
  const scale = pickAfterLabel(t, "Scale:");
  const nr = pickAfterLabel(t, "Nr:");

  const block = grabBetween(t, "Added to website:", "Our price:");
  let reg = (extractRegistrationFromBlock(block) || "").trim();
  if(!reg) reg = (extractRegistrationFromBlock(t) || "").trim();

  const ok = (brand || airline || aircraft) && (scale || brand);
  if(!ok) return null;

  return {
    brand: brand || "",
    airline: airline || "",
    aircraft: aircraft || "",
    reg: reg || "",
    scale: scale || "",
    _nr: nr || ""
  };
}

/** ---------- Source 2: WingsWorld ---------- */
async function lookupWingsWorld(sku){
  const q = `site:wingsworld.cn ${sku}`;
  const url = await ddgSearchFirstUrlByDomain(q, "wingsworld.cn");
  if(!url) return null;

  const text = await fetchTextViaJina(url);

  const line = findBestLineContainingSKU(text, sku);
  const parsed = parseWingsWorldLine(line, sku);
  const fallback = parsed || parseGenericFromText(text, sku);
  if(!fallback) return null;

  return { ...fallback, source: "WingsWorld", url };
}

function findBestLineContainingSKU(text, sku){
  const lines = (text || "").replace(/\r/g,"").split("\n").map(s=>s.trim()).filter(Boolean);
  const target = normalizeSKU(sku);
  const candidates = lines.filter(l => l.toUpperCase().includes(target));
  if(!candidates.length) return "";

  candidates.sort((a,b)=>{
    const score = (l)=>{
      let s=0;
      if(/\b1:\d+\b/.test(l)) s+=3;
      if(/\b(Boeing|Airbus|Embraer|ATR|Bombardier)\b/i.test(l)) s+=3;
      if(/\b(JC|Wings|NG|Phoenix|Gemini|Herpa)\b/i.test(l)) s+=2;
      s += Math.max(0, 60 - l.length)/60;
      return s;
    };
    return score(b) - score(a);
  });

  return candidates[0];
}

function parseWingsWorldLine(line, sku){
  if(!line) return null;

  const scale = (line.match(/\b1:\d+\b/i)?.[0] || "").trim();
  const reg = (extractRegistrationFromBlock(line) || "").trim();
  const aircraft = extractAircraftFromText(line) || "";
  const brand = extractBrandFromText(line) || "";
  let airline = line;

  [aircraft, reg, sku, scale, brand].filter(Boolean).forEach(x=>{
    airline = airline.replaceAll(x, " ");
  });
  airline = airline.replace(/\s+/g," ").trim();

  const ok = (brand || airline || aircraft) && (scale || brand || aircraft);
  if(!ok) return null;

  return { brand, airline, aircraft, reg, scale };
}

/** ---------- Source 3: AviationMegastore (best-effort) ---------- */
async function lookupAviationMegastore(sku){
  const q = `site:aviationmegastore.com ${sku}`;
  const url = await ddgSearchFirstUrlByDomain(q, "aviationmegastore.com");
  if(!url) return null;

  const text = await fetchTextViaJina(url);
  const parsed = parseAviationMegastoreText(text, sku);
  if(!parsed) return null;

  return { ...parsed, source: "AviationMegastore", url };
}

function parseAviationMegastoreText(text, sku){
  const t = (text || "").replace(/\r/g,"");
  const h1 = (t.match(/^#\s+(.+)$/m)?.[1] || "").trim();
  const h2 = (t.match(/^##\s+(.+)$/m)?.[1] || "").trim();
  const combined = [h1,h2].filter(Boolean).join(" | ");

  const brand = extractBrandFromText(combined) || pickAfterLabel(t, "Brand:") || "";
  const scale = (combined.match(/\b1:\d+\b/i)?.[0] || pickAfterLabel(t, "Scale:") || "").trim();
  const reg = (extractRegistrationFromBlock(combined) || extractRegistrationFromBlock(t) || "").trim();
  const aircraft = extractAircraftFromText(combined) || extractAircraftFromText(t) || "";

  let airline = combined || "";
  [brand, aircraft, reg, scale, sku].filter(Boolean).forEach(x=>{
    airline = airline.replaceAll(x, " ");
  });
  airline = airline.replace(/\s+/g," ").trim();

  const fallback = parseGenericFromText(t, sku);
  const candidate = {
    brand: brand || fallback?.brand || "",
    airline: airline || fallback?.airline || "",
    aircraft: aircraft || fallback?.aircraft || "",
    reg: reg || fallback?.reg || "",
    scale: scale || fallback?.scale || ""
  };

  const ok = (candidate.brand || candidate.airline || candidate.aircraft) && (candidate.scale || candidate.brand || candidate.aircraft);
  return ok ? candidate : null;
}

/** ---------- Generic extractors ---------- */
function pickAfterLabel(text, label){
  const re = new RegExp(escapeRegex(label) + "\\s*([^\\n]+)", "i");
  const m = String(text || "").match(re);
  return m ? m[1].trim() : "";
}

function grabBetween(text, a, b){
  const s = String(text || "");
  const ia = s.toLowerCase().indexOf(String(a).toLowerCase());
  const ib = s.toLowerCase().indexOf(String(b).toLowerCase());
  if(ia === -1) return "";
  if(ib !== -1 && ib > ia) return s.slice(ia, ib);
  return s.slice(ia);
}

function extractRegistrationFromBlock(text){
  if(!text) return "";

  const lines = String(text).split("\n").map(x=>x.trim()).filter(Boolean);
  for(const line of lines){
    if(/our price|added to website|in stock|scale:|brand:|nr:|material|stand|add to cart|cart|price/i.test(line)) continue;
    if(line.length > 40) continue;

    const re = /\b([A-Z]{1,3}-[A-Z0-9]{2,6}|N[0-9]{1,5}[A-Z]{0,2}|JA[0-9]{3,4}[A-Z]{0,2}|B-[0-9]{3,5}|HL[0-9]{3,5}|D-[A-Z]{3,4}|PH-[A-Z0-9]{3,4})\b/;
    const m = line.match(re);
    if(m) return m[1];
  }

  const m2 = String(text).match(/\b([A-Z]{1,3}-[A-Z0-9]{2,6}|N[0-9]{1,5}[A-Z]{0,2}|JA[0-9]{3,4}[A-Z]{0,2}|B-[0-9]{3,5}|HL[0-9]{3,5}|D-[A-Z]{3,4}|PH-[A-Z0-9]{3,4})\b/);
  return m2 ? m2[1] : "";
}

function extractAircraftFromText(text){
  const s = String(text || "");
  const m = s.match(/\b(Boeing|Airbus|Embraer|ATR|Bombardier|McDonnell|Douglas|Lockheed|Antonov)\b[^|,\n]{0,60}/i);
  if(!m) return "";
  return m[0].replace(/\s{2,}/g," ").trim();
}

function extractBrandFromText(text){
  const s = String(text || "");
  const known = [
    "JC Wings","NG Models","Phoenix","GeminiJets","Gemini Jets","Herpa","Inflight200","Inflight 200",
    "AeroClassics","Aeroclassics","SkyMarks","Skymarks","Hogan","Witty","Panda Models","Panda",
    "BigBird","Big Bird","LimoX","Limox"
  ];

  for(const b of known){
    const re = new RegExp("\\b" + escapeRegex(b) + "\\b", "i");
    if(re.test(s)) return normalizeBrandName(b);
  }

  if(/\bJC\b/i.test(s) && /\bWINGS\b/i.test(s)) return "JC Wings";
  return "";
}

function normalizeBrandName(b){
  if(/^gemini\s*jets$/i.test(b)) return "GeminiJets";
  if(/^inflight\s*200$/i.test(b)) return "Inflight200";
  return b;
}

function parseGenericFromText(text, sku){
  const t = String(text || "");
  const brand = extractBrandFromText(t) || "";
  const scale = (t.match(/\b1:\d+\b/i)?.[0] || "").trim();
  const reg = (extractRegistrationFromBlock(t) || "").trim();
  const aircraft = extractAircraftFromText(t) || "";

  const line = findBestLineContainingSKU(t, sku) || "";
  let airline = line || "";
  [brand, aircraft, reg, scale, sku].filter(Boolean).forEach(x=>{
    airline = airline.replaceAll(x, " ");
  });
  airline = airline.replace(/\s+/g," ").trim();

  const ok = (brand || airline || aircraft) && (scale || brand || aircraft);
  if(!ok) return null;
  return { brand, airline, aircraft, reg, scale };
}

/** ==========================
 *  Import / Export
 *  ========================== */
function exportToBox(obj){
  el("exportBox").textContent = JSON.stringify(obj, null, 2);
}

function copyExport(){
  const txt = el("exportBox").textContent || "";
  navigator.clipboard.writeText(txt)
    .then(()=>toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚"))
    .catch(()=>toast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚","warn"));
}

function doExportCatalog(){
  exportToBox(catalog);
  toast("å·²åŒ¯å‡º Catalog åˆ°å³å´æ¡†ã€‚");
}

function doExportInventory(){
  exportToBox(inventory);
  toast("å·²åŒ¯å‡º Inventory åˆ°å³å´æ¡†ã€‚");
}

function parseJsonArea(){
  const raw = el("jsonArea").value.trim();
  if(!raw){ toast("è«‹å…ˆè²¼ä¸Š JSONã€‚","warn"); return null; }
  try{
    const obj = JSON.parse(raw);
    if(typeof obj !== "object" || obj === null){
      toast("JSON å…§å®¹ä¸æ˜¯ç‰©ä»¶ã€‚","warn"); return null;
    }
    return obj;
  }catch(e){
    toast("JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€—è™Ÿèˆ‡æ‹¬è™Ÿã€‚","bad"); return null;
  }
}

function importCatalogFromArea(){
  const obj = parseJsonArea();
  if(!obj) return;

  for(const [sku, v] of Object.entries(obj)){
    if(!v || typeof v !== "object"){
      toast(`Catalog æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad");
      return;
    }
    const need = ["brand","airline","aircraft","reg","scale"];
    for(const k of need){
      if(!(k in v)){
        toast(`Catalog ç¼ºæ¬„ä½ï¼š${sku}.${k}`,"bad");
        return;
      }
    }
  }

  catalog = obj;
  saveJSON(LS_KEYS.catalog, catalog);
  updateKPIs();
  setAutoInfoFromSKU();
  toast("å·²åŒ¯å…¥ Catalogï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
}

function importInventoryFromArea(){
  const obj = parseJsonArea();
  if(!obj) return;

  for(const [sku, v] of Object.entries(obj)){
    if(!v || typeof v !== "object"){
      toast(`Inventory æ ¼å¼ä¸æ­£ç¢ºï¼š${sku}`,"bad");
      return;
    }
    if(!("qty" in v)){
      toast(`Inventory ç¼º qtyï¼š${sku}`,"bad");
      return;
    }
  }

  inventory = obj;
  saveJSON(LS_KEYS.inventory, inventory);
  renderInventory();
  updateKPIs();
  toast("å·²åŒ¯å…¥ Inventoryï¼ˆè¦†è“‹å®Œæˆï¼‰ã€‚","good");
}

function resetDemo(){
  catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
  inventory = {};
  tx = [];
  saveJSON(LS_KEYS.catalog, catalog);
  saveJSON(LS_KEYS.inventory, inventory);
  saveJSON(LS_KEYS.tx, tx);
  clearForm();
  clearSell();
  renderInventory();
  renderTx();
  updateKPIs();
  toast("å·²é‡ç½®ç‚ºç¯„ä¾‹è³‡æ–™ã€‚","good");
}

function wipeAll(){
  localStorage.removeItem(LS_KEYS.catalog);
  localStorage.removeItem(LS_KEYS.inventory);
  localStorage.removeItem(LS_KEYS.lastSave);
  localStorage.removeItem(LS_KEYS.tx);

  catalog = JSON.parse(JSON.stringify(DEMO_CATALOG));
  inventory = {};
  tx = [];
  saveJSON(LS_KEYS.catalog, catalog);
  saveJSON(LS_KEYS.inventory, inventory);
  saveJSON(LS_KEYS.tx, tx);
  clearForm();
  clearSell();
  renderInventory();
  renderTx();
  updateKPIs();
  toast("å·²æ¸…é™¤å…¨éƒ¨è³‡æ–™ä¸¦å›åˆ°ç¯„ä¾‹ç‹€æ…‹ã€‚","bad");
}

/** ==========================
 *  Bind events
 *  ========================== */
el("skuInput").addEventListener("input", setAutoInfoFromSKU);
el("skuInput").addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ addOrUpdateInventory(); }});
el("qtyInput").addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ addOrUpdateInventory(); }});
el("addBtn").addEventListener("click", addOrUpdateInventory);
el("clearFormBtn").addEventListener("click", clearForm);

el("onlineLookupBtn").addEventListener("click", onlineLookup);

el("saveCatalogBtn").addEventListener("click", saveCatalogForSKU);
el("deleteCatalogBtn").addEventListener("click", deleteCatalogForSKU);

el("searchInput").addEventListener("input", renderInventory);

el("exportCatalogBtn").addEventListener("click", doExportCatalog);
el("exportInventoryBtn").addEventListener("click", doExportInventory);
el("importCatalogBtn").addEventListener("click", ()=>toast("æŠŠ Catalog JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Catalog åŒ¯å…¥ã€ã€‚","warn"));
el("importInventoryBtn").addEventListener("click", ()=>toast("æŠŠ Inventory JSON è²¼åˆ°ä¸‹æ–¹è¼¸å…¥æ¡†ï¼Œå†æŒ‰ã€æŠŠé€™ä»½ JSON ç•¶ Inventory åŒ¯å…¥ã€ã€‚","warn"));

el("doImportCatalogBtn").addEventListener("click", importCatalogFromArea);
el("doImportInventoryBtn").addEventListener("click", importInventoryFromArea);

el("copyExportBtn").addEventListener("click", copyExport);
el("resetDemoBtn").addEventListener("click", resetDemo);
el("wipeAllBtn").addEventListener("click", wipeAll);

// sell
el("sellBtn").addEventListener("click", sellDeduct);
el("copySkuBtn").addEventListener("click", copyTopSkuToSell);
el("clearSellBtn").addEventListener("click", clearSell);
el("sellSkuInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sellDeduct(); });
el("sellQtyInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sellDeduct(); });

// init
updateSavePill();
updateKPIs();
setAutoInfoFromSKU();
renderInventory();
renderTx();
toast("è¼‰å…¥å®Œæˆ âœ…", "good");
</script>
</body>
</html>
